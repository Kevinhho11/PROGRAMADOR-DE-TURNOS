<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!--    - primary meta tags  -->
  <title>Programador de Turnos Doria</title>
  <meta name="title" content="Programador de Turnos Doria" />
  <meta name="description" content="Sistema de programaci√≥n de turnos para empleados." />
  <!--    - favicon  -->
  <link rel="shortcut icon" href="/placeholder.svg?height=16&width=16" type="image/svg+xml" />
  <!--    - google font link  -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <base target="_top" />
  <?!= include('style'); ?>
  <style>
    
  </style>
</head>

 <div class="gradient-background">
        <div class="gradient-sphere sphere-1"></div>
        <div class="gradient-sphere sphere-2"></div>
        <div class="gradient-sphere sphere-3"></div>
        <div class="glow"></div>
        <div class="grid-overlay"></div>
        <div class="noise-overlay"></div>
        <div class="particles-container" id="particles-container"></div>
    </div>
<body id="top">

   <svg style="position: absolute; width: 0; height: 0;">
    <filter id="unopaq" y="-100%" height="300%" x="-100%" width="300%">
      <feColorMatrix
        values="1 0 0 0 0 
              0 1 0 0 0 
              0 0 1 0 0 
              0 0 0 5 0"
      ></feColorMatrix>
    </filter>
    <filter id="unopaq2" y="-100%" height="300%" x="-100%" width="300%">
      <feColorMatrix
        values="1 0 0 0 0 
              0 1 0 0 0 
              0 0 1 0 0 
              0 0 0 10 0"
      ></feColorMatrix>
    </filter>
    <filter id="unopaq3" y="-100%" height="300%" x="-100%" width="300%">
      <feColorMatrix
        values="1 0 0 1 0 
              0 1 0 1 0 
              0 0 1 1 0 
              0 0 0 2 0"
      ></feColorMatrix>
    </filter>
  </svg>

  <!--    - #HEADER  -->
  <header class="header" data-header>
    <div class="container">

    
      <a href="#">
        <img
          src="https://drive.google.com/thumbnail?id=1JdbZEXvuJ70V9Z2FgDieQQCrgJbIFnyv"
          width="40"
          height="40"
          alt="Metalink home"
          class="logo-small"
        />
        <img
          src="https://drive.google.com/thumbnail?id=1JdbZEXvuJ70V9Z2FgDieQQCrgJbIFnyv"
          width="40"
          height="28"
          alt="Metalink home"
          class="logo"
        />
      </a>

      
      <nav class="navbar" data-navbar>
        <ul class="navbar-list">
          <li>
            <a href="#inicio" class="navbar-link label-lg link:hover">Inicio</a>
          </li>
          <li>
            <a href="#buscars" class="navbar-link label-lg link:hover">Buscar</a>
          </li>
          <li>
            <a href="#contactars" class="navbar-link label-lg link:hover">Contacto</a>
          </li>
          <li>
            <a href="#" onclick="event.preventDefault(); abrirModal();" class="navbar-link label-lg link:hover" id="loginLink"
              >Iniciar Sesi√≥n</a
            >
          </li>
          <li id="userInfo" class="user-info hidden">
            <span id="userEmail">Usuario</span>
            <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
          </li>
        </ul>
      </nav>
      <div class="header-action">
        <button class="btn-icon profil-btn" aria-label="Metalink account: Fiona doe">
          <img
            src="https://drive.google.com/thumbnail?id=1JdbZEXvuJ70V9Z2FgDieQQCrgJbIFnyv"
            width="50"
            height="50"
            alt="Fiona doe"
            class="img-cover"
          />
        </button>
        <button class="nav-toggle-btn" aria-label="menu toggle" data-nav-toggler>
          <ion-icon name="menu-outline" aria-hidden="true" class="default-icon"></ion-icon>
          <ion-icon name="close-outline" aria-hidden="true" class="active-icon"></ion-icon>
        </button>
      </div>
    </div>
  </header>

<br>

<center>
  <div id="protectedContentTurnos" class="hidden">
    <section id="inicio">
      <!-- From Uiverse.io by ayman-ashine --> 
      <div class="card" onclick="abrirModalTurnosProgramados()">
        <img
          class="image"
          alt=""
          src="https://drive.google.com/thumbnail?id=1AzmE2uI44VqJjhiTe1ZuvO9RrwlO-jh2&sz=w1000"
        />
        <div class="heading">Ver turnos programados</div>
        <div class="icons"></div>
      </div>
    </section>
  </div>
</center>



<div id="turnosProgramadosModal" class="schedule-modal">
  <div class="schedule-content">
    <div class="schedule-header">
      <h2>Turnos Programados</h2>
      <button class="schedule-close" onclick="cerrarModalTurnosProgramados()">&times;</button>
    </div>
    
    <div class="search-container">
      <select id="areaFilter" class="search-type" onchange="filtrarTurnosPorArea()">
        <option value="">Todas las √°reas</option>
        <!-- Se llenar√° din√°micamente -->
      </select>
      
      <div class="export-buttons">
        <button onclick="exportarTurnosAPDF()" class="btn-export">
          Exportar a PDF
        </button>
      </div>
    </div>

    <div class="turnos-table-container">
      <table class="turnos-table">
    <thead>
  <tr>
    <th>Nombre</th>
    <th>Documento</th>
    <th>Cargo</th>
    <th>√Årea</th>
    <th>Lunes</th>
    <th>Martes</th>
    <th>Mi√©rcoles</th>
    <th>Jueves</th>
    <th>Viernes</th>
    <th>S√°bado</th>
    <th>Domingo</th>
    <th>Tipo de Turno</th>
    <th>Periodo</th>
    <th>Comentario</th>
    
  </tr>
</thead>
        <tbody id="turnosProgramadosTableBody">
        </tbody>
      </table>
    </div>
  </div>
</div>

  <!-- Modal de Login -->
 <div id="loginModal" class="modal">
  <div class="modal-content animate login-container">
    <span class="close-button" onclick="cerrarModal()">X</span>
    <br>
     <br>
    <div class="circle circle-one"></div>
    <div class="form-container">
<img src="https://drive.google.com/thumbnail?id=15r5uwSCxagoS5UzAIc5U2giFMF9t1p5_&sz=w1000" alt="illustration" class="illustration" />
      <h2 class="opacity">Iniciar Sesi√≥n</h2>

      <input type="email" id="correo" placeholder="Correo electr√≥nico" autocomplete="email" />
      <input type="password" id="clave" placeholder="Contrase√±a" autocomplete="current-password" />

      <button onclick="loguear()" id="loginBtn">Entrar</button>
      <p id="error" class="error-msg opacity"></p>
    </div>
    <div class="circle circle-two"></div>
  </div>
  <div class="theme-btn-container"></div>
</div>

      <!-- Nueva secci√≥n para turnos p√∫blicos -->
     <section id="publicShiftsSection" class="public-shifts-section">
      <div class="consulta-turnos-highlight">
    <div class="consulta-turnos-glow"></div>
    <div class="consulta-turnos-icon">
      <!-- Puedes cambiar el SVG por otro si prefieres -->
      <svg width="70" height="70" viewBox="0 0 70 70" fill="none">
        <circle cx="35" cy="35" r="32" stroke="#335fff" stroke-width="4" fill="#fff" opacity="0.12"/>
        <circle cx="35" cy="35" r="28" stroke="#f44336" stroke-width="2" fill="none" opacity="0.25"/>
        <path d="M35 18v17l12 7" stroke="#335fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <h2 class="consulta-turnos-title">
      <span>Consulta tus</span>
      <span class="consulta-turnos-gradient">Turnos</span>
    </h2>
    <p class="consulta-turnos-subtitle">
      <ion-icon name="calendar-outline"></ion-icon>
      Consulta aqu√≠ tus turnos programados de forma r√°pida y sencilla.
    </p>
    <div class="consulta-turnos-filters">
      <input type="text" id="publicShiftNameSearch" placeholder="Buscar por nombre..." />
      <input type="text" id="publicShiftDocSearch" placeholder="Buscar por documento..." />
      <button id="publicShiftSearchBtn">Buscar Turnos</button>
    </div>
     <div id="publicShiftsContainer" class="public-shifts-table-container">
  <table class="public-shifts-table">
    <thead>
      <tr>
 <th><span class="material-symbols-outlined icon-table">person</span> Nombre</th>
<th><span class="icon-table">ü™™</span> Documento</th>
<th><span class="icon-table">üíº</span> Cargo</th>
<th><span class="icon-table">üè¢</span> √Årea</th>
<th><span class="icon-table">üåû</span> Lunes</th>
<th><span class="icon-table">üåû</span> Martes</th>
<th><span class="icon-table">üåû</span> Mi√©rcoles</th>
<th><span class="icon-table">üåû</span> Jueves</th>
<th><span class="icon-table">üåû</span> Viernes</th>
<th><span class="icon-table">üõ†Ô∏è</span> S√°bado</th>
<th><span class="icon-table">üõå</span> Domingo</th>
<th><span class="icon-table">üìÖ</span> Periodo</th>
<th><span class="icon-table">üí¨</span> Comentario</th>
      </tr>
    </thead>
    <tbody id="publicShiftsTableBody">
      <!-- Aqu√≠ se cargan los turnos din√°micamente -->
    </tbody>
  </table>
</div>
  </section>
      <br />




  <center>
    <div class="table-container">
      <button class="btn-gaming close-table-btn" onclick="hideTable()">
        <span>‚úï</span>
      </button>
      <button class="btn-gaming show-table-btn" onclick="showTable()">
        <span>Mostrar Brigadistas</span>
      </button>
      <main class="table" id="customers_table" style="display: none">
        <section class="table__header">
          
          <h1>BRIGADISTAS</h1>
          <div class="input-group">
            <input type="search" placeholder="Buscar Brigadistas..." />
            <img src="/placeholder.svg?height=20&width=20" alt="" />
          </div>

       
          <div class="export__file">
            <label for="export-file" class="export__file-btn" title="Export File"></label>
            <input type="checkbox" id="export-file" />
            <div class="export__file-options">
              <label>Export As &nbsp; &#10140;</label>
              <label for="export-file" id="toPDF"
                >PDF <img src="https://i.pinimg.com/564x/81/97/55/81975517a51651e8f8940759360d01da.jpg" alt=""
              /></label>
              <label for="export-file" id="toJSON"
                >JSON <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT3PE-GaCP8a_HAcoO6W2KAwRcUhOm-wfXxbQ&s" alt=""
              /></label>
              <label for="export-file" id="toCSV"
                >CSV <img src="https://cdn-icons-png.flaticon.com/512/9496/9496460.png" alt=""
              /></label>
              <label for="export-file" id="toEXCEL"
                >EXCEL
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/34/Microsoft_Office_Excel_%282019%E2%80%93present%29.svg/800px-Microsoft_Office_Excel_%282019%E2%80%93present%29.svg.png"
                  alt=""
                />
              </label>
            </div>
          </div>
          
        </section>
        <section class="table__body">
        <div class="brigadistas-table-container">
  <table class="brigadistas-table" id="brigadistasTable">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Proceso</th>
        <th>Alturas/Confinados</th>
        <th>Tel√©fono</th>

        <th>Lunes</th>
        <th>Martes</th>
        <th>Mi√©rcoles</th>
        <th>Jueves</th>
        <th>Viernes</th>
        <th>S√°bado</th>
        <th>Domingo</th>
      </tr>
    </thead>
    <tbody>
      <!-- Aqu√≠ se cargan los brigadistas din√°micamente -->
    </tbody>
  </table>
</div>
        </section>
      </main>
    </div>
  </center>
  <section id="buscars">
  <main>
    <article>
      <!-- Contenido protegido -->
      <div id="protectedContent" class="hidden">
        <article>
          <section class="section hero" aria-label="home">
            <div class="container">
              <h1 class="headline-lg hero-title">
                PROGRAMAR
                <span class="span">TURNOS</span>
              </h1>
   
              <p class="section-text body-lg">Ac√° podr√° programar los turnos de los empleados, pero especificamente de su √°rea!</p>
              <div class="hero">
                <a href="#" class="btn" id="programarBtn">Programar</a>
                
              </div>
              <br>
              <br>
              <center>
              <a href="https://www.appsheet.com/start/560d1208-9593-4878-9864-044f1fefee6c" target="_blank" style="text-decoration: none;">
  <div class="card-border-extras">
    <div class="card-bg-extras"> 
      <div class="container-logo-extras">
    
        <div class="logo-inside-extras">
          <div class="first-extras"></div>
          <div class="second-extras"></div>
        </div>
      </div>
      <div id="blur-area-extras"></div>
      <div class="marquee-extras">
        <div class="marquee__inner-extras" aria-hidden="true">
          <span class="viper-extras">Horas Extras Horas Extras</span>
          <span class="viper-extras">Horas Extras Horas Extras</span>
          <span class="viper-extras">Horas Extras Horas Extras</span>
        </div>
      </div>
    </div>
    <div class="mist-container-extras">
      <div class="mist-extras"></div>
    </div>
    <strong id="text-ext-extras">Registro de Horas Extras</strong>
    <strong id="text-border-extras">Click para el registro</strong>
  </div>
</a>
              </center>
            </div>
          </section>
        </article>
      </div>
      <!-- Contenido p√∫blico (login prompt) -->
      <div id="publicContent">
  <div class="welcome-card">
    <div class="welcome-icon">
      <ion-icon name="calendar-outline"></ion-icon>
    </div>
    <h2 class="welcome-title">Bienvenido al Sistema de Turnos</h2>
    <p class="welcome-desc">
      Para acceder a la programaci√≥n y gesti√≥n de turnos, por favor inicia sesi√≥n con tus credenciales corporativas.
    </p>
  </div>
</div>

      <br />
<!-- Modal de selecci√≥n de √°rea -->
      <div id="optionsCustomModal" class="custom-modal">
        <div class="custom-modal-content">
          <div class="custom-modal-header">
            <h2 class="custom-modal-title">Seleccione un √°rea</h2>
            <button class="custom-close-btn" id="closeCustomModal">&times;</button>
          </div>
          <div class="option-list">
            <!-- Materias primas -->
            <div class="option-item" data-option="materias-primas">
              <img src="https://drive.google.com/thumbnail?id=12jWdoOGrqDGpexgXX_e9WHswtXk-5aQi&sz=w1000" alt="Materias primas" />
              <div class="option-content">
                <div class="option-category">√Årea de producci√≥n</div>
                <div class="option-name">Materias primas</div>
                <div class="option-select">Seleccionar

                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                  
                </div>
                
              </div>
            </div>
            <!-- Molino -->
            <div class="option-item" data-option="molino">
              <img src="https://drive.google.com/thumbnail?id=1Usw5-YC9wsSSRisL5ftUJZYAFt-uMQ05&sz=w1000" alt="Molino" />
              <div class="option-content">
                <div class="option-category">√Årea de producci√≥n</div>
                <div class="option-name">Molino</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>
            <!-- Cedi -->
            <div class="option-item" data-option="cedi">
              <img src= "https://drive.google.com/thumbnail?id=1CWDjbGRVZfmJtuco-jPdyH_de6bca-MJ&sz=w1200" alt="Cedi" />
              <div class="option-content">
                <div class="option-category">√Årea log√≠stica</div>
                <div class="option-name">Cedi</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>
         

            <!-- Calidad -->
            <div class="option-item" data-option="calidad">
              <img src="/placeholder.svg?height=64&width=64" alt="Calidad" />
              <div class="option-content">
                <div class="option-category">√Årea de control</div>
                <div class="option-name">Calidad</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>
            <!-- SST -->
            <div class="option-item" data-option="sst">
              <img src="/placeholder.svg?height=64&width=64" alt="SST" />
              <div class="option-content">
                <div class="option-category">√Årea de seguridad</div>
                <div class="option-name">SST</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>

            <!-- Almac√©n general -->
            <div class="option-item" data-option="almacen-general">
              <img src="/placeholder.svg?height=64&width=64" alt="Almac√©n General" />
              <div class="option-content">
                <div class="option-category">√Årea log√≠stica</div>
                <div class="option-name">Almac√©n General</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>
            <!-- Ingenier√≠a y montaje -->
            <div class="option-item" data-option="ingenieria-montaje">
              <img src="/placeholder.svg?height=64&width=64" alt="Ingenier√≠a y montaje" />
              <div class="option-content">
                <div class="option-category">√Årea t√©cnica</div>
                <div class="option-name">Ingenier√≠a y montaje</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>





            <!-- Coordinador de distribuci√≥n -->
            <div class="option-item" data-option="coordinador-distribucion">
              <img src="/placeholder.svg?height=64&width=64" alt="Coordinador de distribuci√≥n" />
              <div class="option-content">
                <div class="option-category">√Årea log√≠stica</div>
                <div class="option-name">SIP</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>
            <!-- Analista control y gesti√≥n -->
            <div class="option-item" data-option="analista-control-gestion">
              <img src="/placeholder.svg?height=64&width=64" alt="Analista control y gesti√≥n" />
              <div class="option-content">
                <div class="option-category">√Årea de control</div>
                <div class="option-name">Analista control y gesti√≥n</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>
            <!-- Producci√≥n (General) -->
            <div class="option-item" data-option="produccion">
              <img src="/placeholder.svg?height=64&width=64" alt="Producci√≥n" />
              <div class="option-content">
                <div class="option-category">√Årea de producci√≥n</div>
                <div class="option-name">Producci√≥n</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>

            <!-- Gesti√≥n Ambiental -->
            <div class="option-item" data-option="gestion-ambiental">
              <img src="/placeholder.svg?height=64&width=64" alt="Gesti√≥n Ambiental" />
              <div class="option-content">
                <div class="option-category">√Årea de gesti√≥n</div>
                <div class="option-name">Gesti√≥n Ambiental</div>
                <div class="option-select">Seleccionar
                   <svg fill="currentColor" viewBox="0 0 24 24" class="icon">
    <path
      clip-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm4.28 10.28a.75.75 0 000-1.06l-3-3a.75.75 0 10-1.06 1.06l1.72 1.72H8.25a.75.75 0 000 1.5h5.69l-1.72 1.72a.75.75 0 101.06 1.06l3-3z"
      fill-rule="evenodd"
    ></path>
  </svg>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
      <!-- Modal de opciones por √°rea -->
      <div id="areaOptionsModal" class="area-options-modal">
        <div class="area-options-content">
          <div class="area-options-header">
            <h2 class="area-options-title" id="areaOptionsTitle">Opciones del √Årea</h2>
            <button class="area-options-close" id="closeAreaOptionsModal">&times;</button>
          </div>
          <div class="area-options-list">
            <button class="area-option-btn" id="nuevoRegistroBtn">
              Nuevo Registro
              <i>‚ñº</i>
            </button>
            <div class="sub-options" id="nuevoRegistroOptions">
              <div class="sub-option" data-action="semanal">Semanal</div>
              <div class="sub-option" data-action="rango-semanas">Rango de semanas</div>
              <div class="sub-option" data-action="anual">Anual</div>
            </div>
            <button class="area-option-btn" id="editarRegistroBtn">
              Editar Registros
              <i>‚ñº</i>
            </button>
            <div class="sub-options" id="editarRegistroOptions">
              <div class="sub-option" data-action="editar-semanal">Semanal</div>
              <div class="sub-option" data-action="editar-rango">Rango de semanas</div>
              <div class="sub-option" data-action="editar-anual">Anual</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal de selecci√≥n de empleados MEJORADO -->
      <div id="employeeModal" class="schedule-modal">
        <div class="schedule-content">
          <div class="schedule-header">
            <h2>Seleccionar Empleados</h2>
            <button class="schedule-close" id="closeEmployeeModal">&times;</button>
          </div>
          
          <!-- Agregado contador y botones de selecci√≥n masiva -->
          <div class="selection-controls">
            <div class="selected-count">
              <span id="selectedCount">0</span> empleados seleccionados
            </div>
            
          </div>
          
          <div class="search-container">
            <input type="text" id="employeeSearch" class="search-input" placeholder="Buscar empleado..." />
            <select id="searchType" class="search-type">
              <option value="all">Todo</option>
              <option value="documento">Documento</option>
              <option value="nombre">Nombre</option>
              <option value="cargo">Cargo</option>
            </select>
            <button id="searchBtn" class="btn btn-primary">Buscar</button>
          </div>
          
          <div class="employees-table-container">
            <table class="employees-table" id="employeesTable">
              <thead>
                <tr>
                  <!-- Agregada columna de checkbox -->
                  <th>
                    <input type="checkbox" id="selectAllCheckbox" title="Seleccionar todos">
                  </th>
                  <th>Documento</th>
                  <th>Nombre</th>
                  <th>Cargo</th>
                </tr>
              </thead>
              <tbody id="employeesTableBody">
                <!-- Los empleados se cargar√°n aqu√≠ -->
              </tbody>
            </table>
          </div>

<div class="bulk-actions">
              <button id="selectAllBtn" class="btn btn-secondary">Seleccionar Todos</button>
              <button id="clearSelectionBtn" class="btn btn-secondary">Limpiar Selecci√≥n</button>
            </div>
          
          <!-- Bot√≥n para continuar con empleados seleccionados -->
          <div class="modal-actions">
            <div class="btn-wrapper">
              <button id="continueWithSelectedBtn" class="btn" disabled>
                <span class="btn-txt">Continuar con empleados</span>
                <div class="dot pulse"></div>
              </button>
              <span class="disclaimer-txt">*Seleccione al menos un empleado</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Modal de edici√≥n semanal -->
      <div id="editWeeklyScheduleModal" class="schedule-modal">
        <div class="schedule-content">
          <div class="schedule-header">
            <h2>Editar Programaci√≥n Semanal</h2>
            <button class="schedule-close" id="closeEditWeeklyModal">&times;</button>
          </div>
          <div class="employee-info" id="editSelectedEmployeeInfo">
            <!-- Info del empleado seleccionado -->
          </div>
          <div class="search-container">
            <input type="text" id="editWeeklySearchInput" class="text-input" placeholder="Buscar por documento o nombre..." />
            <button id="searchWeekBtn" class="btn btn-primary">Buscar</button>
          </div>
          <div class="schedule-table">
            <table class="weekly-table" id="editWeeklyTable">
              <thead>
                <tr>
                  <th>Documento</th>
                  <th>Nombre</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="editWeeklyTableBody">
                <!-- Las programaciones semanales se cargar√°n aqu√≠ -->
              </tbody>
            </table>
          </div>
          <div class="schedule-actions">
            <button class="btn btn-secondary" onclick="cerrarModalEdicionSemanal()">Cancelar</button>
          </div>
        </div>
      </div>
      <!-- Modal para editar una semana espec√≠fica -->
      <div id="editSpecificWeekModal" class="schedule-modal">
        <div class="schedule-content">
          <div class="schedule-header">
            <h2>Editar Semana</h2>
            <button class="schedule-close" id="closeEditSpecificWeekModal">&times;</button>
          </div>
          <div class="employee-info" id="editWeekEmployeeInfo">
            <!-- Info del empleado seleccionado -->
          </div>
          <div class="week-info" id="editWeekInfo">
            <!-- Info de la semana seleccionada -->
          </div>
          <div class="schedule-table">
            <table class="weekly-table">
              <thead>
                <tr>
                  <th>D√≠a</th>
                  <th>Turno</th>
                </tr>
              </thead>
              <tbody id="editWeekTurnsBody">
                <!-- Los turnos de la semana se cargar√°n aqu√≠ din√°micamente -->
              </tbody>
            </table>
          </div>

          <!-- ...existing code... -->
<div class="comment-section">
  <label for="editWeeklyComment">Comentario (opcional):</label>
  <textarea id="editWeeklyComment" class="schedule-comment" placeholder="Agregue un comentario sobre esta programaci√≥n..."></textarea>
</div>
<!-- ...existing code... -->
          <div class="schedule-actions">
            <button class="btn btn-secondary" onclick="cerrarModalEdicionSemanaEspecifica()">Cancelar</button>
            <button class="btn btn-primary" onclick="guardarEdicionSemanal()">Guardar Cambios</button>
            <button class="btn btn-danger" onclick="eliminarProgramacionSemanal()">Eliminar Programaci√≥n</button>
          </div>
        </div>
      </div>
      <!-- Modal de edici√≥n por rango -->
      <div id="editRangeScheduleModal" class="schedule-modal">
        <div class="schedule-content">
          <div class="schedule-header">
            <h2>Editar Programaci√≥n por Rango</h2>
            <button class="schedule-close" id="closeEditRangeModal">&times;</button>
          </div>
          <div class="employee-info" id="editRangeEmployeeInfo">
            <!-- Info del empleado seleccionado -->
          </div>
          <div class="search-container">
            <input type="text" id="editRangeSearch" placeholder="Buscar por documento o nombre..." />
            <button id="searchRangeBtn" class="btn btn-primary">Buscar</button>
          </div>
          <div class="schedule-table">
            <table class="range-table" id="editRangeTable">
              <thead>
                <tr>
                  <th>Documento</th>
                  <th>Nombre</th>
                  <th>Fecha Inicio</th>
                  <th>Fecha Fin</th>
                  <th>Turno</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="editRangeTableBody">
                <!-- Las programaciones por rango se cargar√°n aqu√≠ -->
              </tbody>
            </table>
          </div>
          <div class="schedule-actions">
            <button class="btn btn-secondary" onclick="cerrarModalEdicionRango()">Cancelar</button>
            <!-- Los botones de guardar y eliminar para rango se mover√°n al modal de programaci√≥n original -->
                   </div>
        </div>
      </div>
      <!-- Modal de edici√≥n anual -->
      <div id="editAnnualScheduleModal" class="schedule-modal">
        <div class="schedule-content">
          <div class="schedule-header">
            <h2>Editar Programaci√≥n Anual</h2>
            <button class="schedule-close" id="closeEditAnnualModal">&times;</button>
          </div>
          <div class="employee-info" id="editAnnualEmployeeInfo">
            <!-- Info del empleado seleccionado -->
          </div>
          <div class="search-container">
            <input type="number" id="editAnnualYearSearch" placeholder="Buscar por a√±o..." min="2020" max="2030" />
            <button id="searchAnnualBtn" class="btn btn-primary">Buscar</button>
          </div>
          <div class="schedule-table">
            <table class="annual-table" id="editAnnualTable">
              <thead>
                <tr>
                  <th>Documento</th>
                  <th>Nombre</th>
                  <th>A√±o</th>
                  <th>Tipo Turno</th>
                  <th>Turno Inicio</th>
                  <th>Fijo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="editAnnualTableBody">
                <!-- Las programaciones anuales se cargar√°n aqu√≠ -->
              </tbody>
            </table>
          </div>
          <div class="schedule-actions">
            <button class="btn btn-secondary" onclick="cerrarModalEdicionAnual()">Cancelar</button>
            <!-- Los botones de guardar y eliminar para anual se mover√°n al modal de programaci√≥n original -->
          </div>
        </div>
      </div>
      <!-- Modal de programaci√≥n semanal -->
      <div id="weeklyScheduleModal" class="schedule-modal">
        <div class="schedule-content">
          <div class="schedule-header">
            <h2>Programaci√≥n Semanal</h2>
            <button class="schedule-close" id="closeWeeklyModal">&times;</button>
          </div>
          <div class="employee-info" id="selectedEmployeeInfo">
            <!-- Info del empleado seleccionado -->
          </div>
          <div class="week-selector">
            <label for="weekStart">Semana inicio:</label>
            <input type="week" id="weekStart" class="week-input" />
          </div>
          <div class="schedule-table">
            <table class="weekly-table">
              <thead>
                <tr>
                  <th>D√≠a</th>
                  <th>Turno</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Lunes</td>
                  <td>
                    <select class="turn-select" data-day="lunes">
                      <option value="DESCANSO">Descanso</option>
                      <option value="VACACIONES">Vacaciones</option>
                      <option value="ANTIGUEDAD">Antig√ºedad</option>
                      <option value="CAPACITACION">Capacitaci√≥n</option>
                      <option value="INCAPACIDAD">Incapacidad</option>
                      <option value="PERMISO">Permiso</option>
                      <option value="EVENTO">Evento</option>
                      <option value="COMPENSATORIO">Compensatorio</option>
                      <option value="BRIGADA">Brigada</option>
                      <option value="DOMINGO">Domingo</option>
                      <option value="PASANTIA">Pasant√≠a</option>
                      <option value="CALAMIDAD">Calamidad</option>
                      <option value="AISLAMIENTO">Aislamiento</option>
                      <option value="CITA_EPS">Cita EPS</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>Martes</td>
                  <td>
                    <select class="turn-select" data-day="martes">
                      <option value="DESCANSO">Descanso</option>
                      <option value="VACACIONES">Vacaciones</option>
                      <option value="ANTIGUEDAD">Antig√ºedad</option>
                      <option value="CAPACITACION">Capacitaci√≥n</option>
                      <option value="INCAPACIDAD">Incapacidad</option>
                      <option value="PERMISO">Permiso</option>
                      <option value="EVENTO">Evento</option>
                      <option value="COMPENSATORIO">Compensatorio</option>
                      <option value="BRIGADA">Brigada</option>
                      <option value="DOMINGO">Domingo</option>
                      <option value="PASANTIA">Pasant√≠a</option>
                      <option value="CALAMIDAD">Calamidad</option>
                      <option value="AISLAMIENTO">Aislamiento</option>
                      <option value="CITA_EPS">Cita EPS</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>Mi√©rcoles</td>
                  <td>
                    <select class="turn-select" data-day="miercoles">
                      <option value="DESCANSO">Descanso</option>
                      <option value="VACACIONES">Vacaciones</option>
                      <option value="ANTIGUEDAD">Antig√ºedad</option>
                      <option value="CAPACITACION">Capacitaci√≥n</option>
                      <option value="INCAPACIDAD">Incapacidad</option>
                      <option value="PERMISO">Permiso</option>
                      <option value="EVENTO">Evento</option>
                      <option value="COMPENSATORIO">Compensatorio</option>
                      <option value="BRIGADA">Brigada</option>
                      <option value="DOMINGO">Domingo</option>
                      <option value="PASANTIA">Pasant√≠a</option>
                      <option value="CALAMIDAD">Calamidad</option>
                      <option value="AISLAMIENTO">Aislamiento</option>
                      <option value="CITA_EPS">Cita EPS</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>Jueves</td>
                  <td>
                    <select class="turn-select" data-day="jueves">
                      <option value="DESCANSO">Descanso</option>
                      <option value="VACACIONES">Vacaciones</option>
                      <option value="ANTIGUEDAD">Antig√ºedad</option>
                      <option value="CAPACITACION">Capacitaci√≥n</option>
                      <option value="INCAPACIDAD">Incapacidad</option>
                      <option value="PERMISO">Permiso</option>
                      <option value="EVENTO">Evento</option>
                      <option value="COMPENSATORIO">Compensatorio</option>
                      <option value="BRIGADA">Brigada</option>
                      <option value="DOMINGO">Domingo</option>
                      <option value="PASANTIA">Pasant√≠a</option>
                      <option value="CALAMIDAD">Calamidad</option>
                      <option value="AISLAMIENTO">Aislamiento</option>
                      <option value="CITA_EPS">Cita EPS</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>Viernes</td>
                  <td>
                    <select class="turn-select" data-day="viernes">
                      <option value="DESCANSO">Descanso</option>
                      <option value="VACACIONES">Vacaciones</option>
                      <option value="ANTIGUEDAD">Antig√ºedad</option>
                      <option value="CAPACITACION">Capacitaci√≥n</option>
                      <option value="INCAPACIDAD">Incapacidad</option>
                      <option value="PERMISO">Permiso</option>
                      <option value="EVENTO">Evento</option>
                      <option value="COMPENSATORIO">Compensatorio</option>
                      <option value="BRIGADA">Brigada</option>
                      <option value="DOMINGO">Domingo</option>
                      <option value="PASANTIA">Pasant√≠a</option>
                      <option value="CALAMIDAD">Calamidad</option>
                      <option value="AISLAMIENTO">Aislamiento</option>
                      <option value="CITA_EPS">Cita EPS</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>S√°bado</td>
                  <td>
                    <select class="turn-select" data-day="sabado">
                      <option value="DESCANSO">Descanso</option>
                      <option value="VACACIONES">Vacaciones</option>
                      <option value="ANTIGUEDAD">Antig√ºedad</option>
                      <option value="CAPACITACION">Capacitaci√≥n</option>
                      <option value="INCAPACIDAD">Incapacidad</option>
                      <option value="PERMISO">Permiso</option>
                      <option value="EVENTO">Evento</option>
                      <option value="COMPENSATORIO">Compensatorio</option>
                      <option value="BRIGADA">Brigada</option>
                      <option value="DOMINGO">Domingo</option>
                      <option value="PASANTIA">Pasant√≠a</option>
                      <option value="CALAMIDAD">Calamidad</option>
                      <option value="AISLAMIENTO">Aislamiento</option>
                      <option value="CITA_EPS">Cita EPS</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>Domingo</td>
                  <td>
                    <select class="turn-select" data-day="domingo">
                      <option value="DESCANSO" selected>Descanso</option>
                      <option value="VACACIONES">Vacaciones</option>
                      <option value="ANTIGUEDAD">Antig√ºedad</option>
                      <option value="CAPACITACION">Capacitaci√≥n</option>
                      <option value="INCAPACIDAD">Incapacidad</option>
                      <option value="PERMISO">Permiso</option>
                      <option value="EVENTO">Evento</option>
                      <option value="COMPENSATORIO">Compensatorio</option>
                      <option value="BRIGADA">Brigada</option>
                      <option value="DOMINGO">Domingo</option>
                      <option value="PASANTIA">Pasant√≠a</option>
                      <option value="CALAMIDAD">Calamidad</option>
                      <option value="AISLAMIENTO">Aislamiento</option>
                      <option value="CITA_EPS">Cita EPS</option>
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="comment-section">
            <label for="weeklyComment">Comentario (opcional):</label>
            <textarea id="weeklyComment" class="schedule-comment" placeholder="Agregue un comentario sobre esta programaci√≥n..."></textarea>
          </div>
          <div class="schedule-actions">
            <button class="btn btn-secondary" onclick="cerrarModalSemanal()">Cancelar</button>
            <button class="btn btn-primary" onclick="guardarProgramacionSemanal()">Guardar Programaci√≥n</button>
          </div>
        </div>
      </div>
      <!-- Modal de programaci√≥n por rango -->
      <div id="rangeScheduleModal" class="schedule-modal">
        <div class="schedule-content">
          <div class="schedule-header">
            <h2>Programaci√≥n por Rango de Semanas</h2>
            <button class="schedule-close" id="closeRangeModal">&times;</button>
          </div>
          <div class="employee-info" id="selectedEmployeeInfoRange">
            <!-- Info del empleado seleccionado -->
          </div>
          <div class="range-form">
            <div class="form-group">
              <label for="rangeStart">Fecha inicio:</label>
              <input type="date" id="rangeStart" class="date-input" />
            </div>
            <div class="form-group">
              <label for="rangeEnd">Fecha fin:</label>
              <input type="date" id="rangeEnd" class="date-input" />
            </div>
            <div class="form-group">
              <label for="rangeTurn">Turno asignado:</label>
              <select id="rangeTurn" class="turn-select">
                <option value="DESCANSO">Descanso</option>
                <option value="VACACIONES">Vacaciones</option>
                <option value="ANTIGUEDAD">Antig√ºedad</option>
                <option value="CAPACITACION">Capacitaci√≥n</option>
                <option value="INCAPACIDAD">Incapacidad</option>
                <option value="PERMISO">Permiso</option>
                <option value="EVENTO">Evento</option>
                <option value="COMPENSATORIO">Compensatorio</option>
                <option value="BRIGADA">Brigada</option>
                <option value="DOMINGO">Domingo</option>
                <option value="PASANTIA">Pasant√≠a</option>
                <option value="CALAMIDAD">Calamidad</option>
                <option value="AISLAMIENTO">Aislamiento</option>
                <option value="CITA_EPS">Cita EPS</option>
              </select>
            </div>
          </div>
          <div class="comment-section">
            <label for="rangeComment">Comentario (opcional):</label>
            <textarea id="rangeComment" class="schedule-comment" placeholder="Agregue un comentario sobre esta programaci√≥n..."></textarea>
          </div>
          <div class="schedule-actions">
            <button class="btn btn-secondary" onclick="cerrarModalRango()">Cancelar</button>
            <button class="btn btn-primary" onclick="guardarProgramacionRango()">Guardar Programaci√≥n</button>
            <button class="btn btn-danger" onclick="eliminarProgramacionRango()">Eliminar Programaci√≥n</button>
          </div>
        </div>
      </div>
      <!-- Modal de programaci√≥n anual -->
      <div id="annualScheduleModal" class="schedule-modal">
        <div class="schedule-content">
          <div class="schedule-header">
            <h2>Programaci√≥n Anual</h2>
            <button class="schedule-close" id="closeAnnualModal">&times;</button>
          </div>
          <div class="employee-info" id="selectedEmployeeInfoAnnual">
            <!-- Info del empleado seleccionado -->
          </div>
          <div class="annual-form">
            <div class="form-group">
              <label for="annualYear">A√±o:</label>
              <input type="number" id="annualYear" class="year-input" min="2024" max="2030" />
            </div>
            <div class="form-group">
              <label for="annualType">Tipo de turno:</label>
              <select id="annualType" class="turn-select">
                <option value="FIJO">Fijo</option>
                <option value="ROTATIVO">Rotativo</option>
                <option value="MIXTO">Mixto</option>
              </select>
            </div>
            <div class="form-group">
              <label for="annualStartTurn">Turno inicio:</label>
              <select id="annualStartTurn" class="turn-select">
                <option value="DESCANSO">Descanso</option>
                <option value="VACACIONES">Vacaciones</option>
                <option value="ANTIGUEDAD">Antig√ºedad</option>
                <option value="CAPACITACION">Capacitaci√≥n</option>
                <option value="INCAPACIDAD">Incapacidad</option>
                <option value="PERMISO">Permiso</option>
                <option value="EVENTO">Evento</option>
                <option value="COMPENSATORIO">Compensatorio</option>
                <option value="BRIGADA">Brigada</option>
                <option value="DOMINGO">Domingo</option>
                <option value="PASANTIA">Pasant√≠a</option>
                <option value="CALAMIDAD">Calamidad</option>
                <option value="AISLAMIENTO">Aislamiento</option>
                <option value="CITA_EPS">Cita EPS</option>
              </select>
            </div>
            <div class="form-group">
              <label> <input type="checkbox" id="annualFixed" /> Turno fijo durante todo el a√±o </label>
            </div>
          </div>
          <div class="comment-section">
            <label for="annualComment">Comentario (opcional):</label>
            <textarea id="annualComment" class="schedule-comment" placeholder="Agregue un comentario sobre esta programaci√≥n..."></textarea>
          </div>
          <div class="schedule-actions">
            <button class="btn btn-secondary" onclick="cerrarModalAnual()">Cancelar</button>
            <button class="btn btn-primary" onclick="guardarProgramacionAnual()">Guardar Programaci√≥n</button>
            <button class="btn btn-danger" onclick="eliminarProgramacionAnual()">Eliminar Programaci√≥n</button>
          </div>
        </div>
      </div>
<!-- Modal para Turno 1 -->
<div id="turno1Modal" class="schedule-modal">
  <div class="schedule-content">
    <div class="schedule-header">
      <h2>Personal en Turno 1</h2>
      <button class="schedule-close" onclick="cerrarModalTurno('turno1Modal')">&times;</button>
    </div>
    <div class="search-container">
      <select id="areaFilterT1" class="search-type" onchange="cargarPersonalEnTurno('T1')">
        <option value="">Todas las √°reas</option>
      </select>
    </div>
    <div id="turno1Content" class="employees-table-container">
      <table class="employees-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Documento</th>
            <th>Cargo</th>
            <th>√Årea</th>
            <th>Lunes</th>
            <th>Martes</th>
            <th>Mi√©rcoles</th>
            <th>Jueves</th>
            <th>Viernes</th>
            <th>S√°bado</th>
            <th>Domingo</th>
          </tr>
        </thead>
        <tbody id="turno1Table"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para Turno 2 -->
<div id="turno2Modal" class="schedule-modal">
  <div class="schedule-content">
    <div class="schedule-header">
      <h2>Personal en Turno 2</h2>
      <button class="schedule-close" onclick="cerrarModalTurno('turno2Modal')">&times;</button>
    </div>
    <div class="search-container">
      <select id="areaFilterT2" class="search-type" onchange="cargarPersonalEnTurno('T2')">
        <option value="">Todas las √°reas</option>
      </select>
    </div>
    <div id="turno2Content" class="employees-table-container">
      <table class="employees-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Documento</th>
            <th>Cargo</th>
            <th>√Årea</th>
            <th>Lunes</th>
            <th>Martes</th>
            <th>Mi√©rcoles</th>
            <th>Jueves</th>
            <th>Viernes</th>
            <th>S√°bado</th>
            <th>Domingo</th>
          </tr>
        </thead>
        <tbody id="turno2Table"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para Turno 3 -->
<div id="turno3Modal" class="schedule-modal">
  <div class="schedule-content">
    <div class="schedule-header">
      <h2>Personal en Turno 3</h2>
      <button class="schedule-close" onclick="cerrarModalTurno('turno3Modal')">&times;</button>
    </div>
    <div class="search-container">
      <select id="areaFilterT3" class="search-type" onchange="cargarPersonalEnTurno('T3')">
        <option value="">Todas las √°reas</option>
      </select>
    </div>
    <div id="turno3Content" class="employees-table-container">
      <table class="employees-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Documento</th>
            <th>Cargo</th>
            <th>√Årea</th>
            <th>Lunes</th>
            <th>Martes</th>
            <th>Mi√©rcoles</th>
            <th>Jueves</th>
            <th>Viernes</th>
            <th>S√°bado</th>
            <th>Domingo</th>
          </tr>
        </thead>
        <tbody id="turno3Table"></tbody>
      </table>
    </div>
  </div>
</div>
  <center>
        <div class="calendar-container">
          <div class="calendar-header">
            <div class="current-date"></div>
          </div>
          <div class="calendar-body">
            <ul class="days"></ul>
          </div>
        </div>
      </center>

      <div class="container">
    <section class="contact-section">
      <h2 class="section-title">¬øTienes preguntas? ¬°Toca aqu√≠!</h2>
      <p class="section-text">
        Ac√° podr√°s preguntar lo que desees acerca de c√≥mo funciona el software por si tienes dudas
      </p>
      
      <a href="https://wa.me/3203706294" class="whatsapp-btn" target="_blank">
        <span class="pulse"></span>
        <ion-icon name="logo-whatsapp"></ion-icon>
        <span class="span">Contactar por WhatsApp</span>
      </a>
      
      <div class="phone-number">
        N√∫mero: 3203706294
      </div>
    </section>
  </div>
        
      </section>
    </article>
  </main>



  <a href="#top" class="back-to-top btn-icon" aria-label="back to top" data-back-top-btn>
    <ion-icon name="arrow-up" aria-hidden="true"></ion-icon>
  </a>
  <div class="body-bg-shape"></div>
  <!-- New custom alert modal structure -->
  <div id="customAlertModal" class="custom-alert-modal hidden">
    <div class="custom-alert-content">
      <p id="customAlertMessage"></p>
      <p style="margin-top: 10px;"><a id="customAlertLink" href="#" target="_blank" style="color: #0000cc; text-decoration: underline;"></a></p>
      <button class="btn btn-primary" onclick="hideCustomAlert()" style="margin-top: 20px;">OK</button>
    </div>
  </div>


<!-- Modal de Calendario para Selecci√≥n de Semanas - MEJORADO -->
<div id="weekCalendarModal" class="schedule-modal" style="display: none;">
  <div class="schedule-content" style="max-width: 900px;">
    <div class="schedule-header">
      <h2>üìÖ Calendario de Turnos - Selecciona una Semana</h2>
      <button class="schedule-close" onclick="cerrarModalCalendario()">&times;</button>
    </div>
    
    <div class="calendar-controls">
      <button class="calendar-nav-btn" onclick="cambiarMes(-1)">
        <ion-icon name="chevron-back-outline"></ion-icon> Mes Anterior
      </button>
      
      <div class="calendar-title" id="calendarMonthYear">Mes 2024</div>
      
      <button class="calendar-nav-btn" onclick="cambiarMes(1)">
        Mes Siguiente <ion-icon name="chevron-forward-outline"></ion-icon>
      </button>
    </div>
    
    <div class="week-calendar-grid">
      <!-- Encabezados de d√≠as -->
      <div class="weekday-header">LUNES</div>
      <div class="weekday-header">MARTES</div>
      <div class="weekday-header">MI√âRCOLES</div>
      <div class="weekday-header">JUEVES</div>
      <div class="weekday-header">VIERNES</div>
      <div class="weekday-header">S√ÅBADO</div>
      <div class="weekday-header">DOMINGO</div>
      
      <!-- Los d√≠as se cargar√°n aqu√≠ din√°micamente -->
      <div id="calendarDaysContainer"></div>
    </div>
    
    <!-- NUEVA SECCI√ìN: Informaci√≥n de turnos por d√≠a -->
    <div class="day-shifts-info">
      <h4>üîÑ Turnos Asignados para la Semana Seleccionada</h4>
      <div class="days-shifts-grid" id="daysShiftsGrid">
        <div class="day-shift-item" data-day="lunes">
          <div class="day-shift-name">LUNES</div>
          <div class="day-shift-turno">-</div>
        </div>
        <div class="day-shift-item" data-day="martes">
          <div class="day-shift-name">MARTES</div>
          <div class="day-shift-turno">-</div>
        </div>
        <div class="day-shift-item" data-day="miercoles">
          <div class="day-shift-name">MI√âRCOLES</div>
          <div class="day-shift-turno">-</div>
        </div>
        <div class="day-shift-item" data-day="jueves">
          <div class="day-shift-name">JUEVES</div>
          <div class="day-shift-turno">-</div>
        </div>
        <div class="day-shift-item" data-day="viernes">
          <div class="day-shift-name">VIERNES</div>
          <div class="day-shift-turno">-</div>
        </div>
        <div class="day-shift-item" data-day="sabado">
          <div class="day-shift-name">S√ÅBADO</div>
          <div class="day-shift-turno">-</div>
        </div>
        <div class="day-shift-item" data-day="domingo">
          <div class="day-shift-name">DOMINGO</div>
          <div class="day-shift-turno">-</div>
        </div>
      </div>
    </div>
    
    <div class="week-selection-info">
      <h4>‚úÖ Semana Seleccionada para Programaci√≥n</h4>
      <p id="selectedWeekDisplay">Por favor, selecciona un d√≠a en el calendario para ver la semana completa</p>
    </div>
    
    <div class="calendar-legend">
      <div class="legend-item">
        <div class="legend-color legend-festivo"></div>
        <span>üéâ D√≠a Festivo Colombia</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-selected"></div>
        <span>‚úÖ Semana Seleccionada</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-today"></div>
        <span>üìÖ Hoy</span>
      </div>
    </div>
    
    <div class="schedule-actions">
      <button class="btn btn-secondary" onclick="cerrarModalCalendario()">Cancelar</button>
      <button class="btn btn-primary" id="confirmWeekSelection" onclick="confirmarSeleccionSemana()" disabled>
        üöÄ Usar Esta Semana para Programar Turnos
      </button>
    </div>
  </div>
</div>


 
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  <!-- Agregar estas librer√≠as en el head del HTML -->
<!-- ...existing code... -->
<!-- Agrega pdfmake antes de tu script principal -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<!-- ...existing code... -->
  <script>






// Variables globales del sistema
    let currentArea = '';
    let currentScheduleType = '';
    let selectedEmployees = []; // Cambiado de selectedEmployee a array
    let currentEditRow = null;
    let currentEditType = ''; // Added for tracking current edit type (semanal, rango, anual)
    // New global variables for public shifts
    let publicShiftNameSearchInput;
    let publicShiftDocSearchInput;
    let publicShiftSearchBtn;
    let publicShiftsContainer;
    let publicShiftsSection; // Added for visibility control
    // Global variable for T-shift options HTML
    let globalTShiftOptionsHtml = '';

    
// Definiciones de turnos y escenarios
const SHIFT_DEFINITIONS = {
  "ESCENARIO 1": {
    "NO DOMINICAL": {
      "T1": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 6.5, "Domingo": 0 },
      "T2": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 6.5, "Domingo": 0 },
      "T3": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 0, "Domingo": 0 }
    }
  },
  "ESCENARIO 2": {
    "SI DOMINICAL": {
      "T1": { "Lunes": 6.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 7.5, "Domingo": 0 },
      "T2": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 8, "Domingo": 0 },
      "T3": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 2, "Domingo": 0 }
    },
    "NO DOMINICAL": {
      "T1": { "Lunes": 6.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 7.5, "Domingo": 0 },
      "T2": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 6.5, "Domingo": 0 },
      "T3": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 0, "Domingo": 0 }
    }
  },
  "ESCENARIO 3": {
    "SI DOMINICAL": {
      "T1": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 7.5, "Domingo": 0 },
      "T2": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 8, "Domingo": 0 },
      "T3": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 8, "Domingo": 8 }
    },
    "NO DOMINICAL": {
      "T1": { "Lunes": 6.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 7.5, "Domingo": 0 },
      "T2": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 6.5, "Domingo": 0 },
      "T3": { "Lunes": 7.5, "Martes": 7.5, "Miercoles": 7.5, "Jueves": 7.5, "Viernes": 7.5, "Sabado": 0, "Domingo": 0 }
    }
  }
};

// Funci√≥n para generar las opciones de turnos
function populateShiftSelects() {
  const tShiftOptionsHtmlArray = [
    '<option value="T1">T1</option>',
    '<option value="T2">T2</option>',
    '<option value="T3">T3</option>',
    '<option value="T1 EXTRA">T1 EXTRA</option>',
    '<option value="T2 EXTRA">T2 EXTRA</option>',
    '<option value="T3 EXTRA">T3 EXTRA</option>'
  ];

  globalTShiftOptionsHtml = tShiftOptionsHtmlArray.join('');

  document.querySelectorAll('.turn-select').forEach(select => {
    if (!select.querySelector('[value="T1"]')) {
      select.innerHTML += globalTShiftOptionsHtml;
    }
  });
}



// Funci√≥n para mostrar alerta de horas extra por dominical
function handleShiftSelectChange(event) {
  const selectedValue = event.target.value;
  hideCustomAlert(); // Siempre ocultar alerta previa
  
  if (selectedValue.includes('EXTRA')) {
    showCustomAlert(
      'Has seleccionado un turno con extras. Por favor, registra las horas extra en AppSheet.', 
      'https://www.appsheet.com/start/560d1208-9593-4878-9864-044f1fefee6c'
    );
  }
}
    window.onload = () => {
      publicShiftNameSearchInput = document.getElementById('publicShiftNameSearch');
      publicShiftDocSearchInput = document.getElementById('publicShiftDocSearch');
      publicShiftSearchBtn = document.getElementById('publicShiftSearchBtn');
      publicShiftsContainer = document.getElementById('publicShiftsContainer');
      publicShiftsSection = document.getElementById('publicShiftsSection');
      
      verificarSesionActiva();
  if (usuarioLogueado) {
    mostrarAreasSegunCargo(usuarioLogueado.cargo);
  }
      configurarEventListeners();
      configurarEventListenersMultiples(); // Nueva funci√≥n
      populateShiftSelects();
      setupShiftSelectListeners();
      // Do NOT call loadPublicShifts() here, it will be called only on search
      if (publicShiftsContainer) {
        publicShiftsContainer.innerHTML = '<p class="no-shifts-message">Por favor, introduce un nombre o documento para buscar turnos.</p>';
      }
    };


    /**NAVBAR TOGGLE FOR MOBILE */
    const navbar = document.querySelector('[data-navbar]');
    const navToggler = document.querySelector('[data-nav-toggler]');
    if (navToggler) {
      navToggler.addEventListener('click', function () {
        navbar.classList.toggle('active');
        this.classList.toggle('active');
      });
    }
    /**HEADER & BACK TOP BTNheader and back top btn visible when window scroll down to 200px */
    const header = document.querySelector('[data-header]');
    const backTopBtn = document.querySelector('[data-back-top-btn]');
    const activeElementOnScroll = () => {
      if (window.scrollY > 200) {
        if (header) header.classList.add('active');
        if (backTopBtn) backTopBtn.classList.add('active');
      } else {
        if (header) header.classList.remove('active');
        if (backTopBtn) backTopBtn.classList.remove('active');
      }
    };
    window.addEventListener('scroll', activeElementOnScroll);
    /**SLIDER */
    const sliders = document.querySelectorAll('[data-slider]');
    const sliderInit = (currentSlider) => {
      const sliderContainer = currentSlider.querySelector('[data-slider-container]');
      const sliderPrevBtn = currentSlider.querySelector('[data-slider-prev]');
      const sliderNextBtn = currentSlider.querySelector('[data-slider-next]');
      const totalSliderVisibleItems = Number(getComputedStyle(currentSlider).getPropertyValue('--slider-item'));
      const totalSliderItems = sliderContainer.childElementCount - totalSliderVisibleItems;
      let currentSlidePos = 0;
      const moveSliderItem = () => {
        sliderContainer.style.transform = `translateX(-${sliderContainer.children[currentSlidePos].offsetLeft}px)`;
      };
      /**NEXT SLIDE */
      const slideNext = () => {
        const slideEnd = currentSlidePos >= totalSliderItems;
        if (slideEnd) {
          currentSlidePos = 0;
        } else {
          currentSlidePos++;
        }
        moveSliderItem();
      };
      if (sliderNextBtn) sliderNextBtn.addEventListener('click', slideNext);
      /**PREVIOUS SLIDE*/
      const slidePrev = () => {
        if (currentSlidePos <= 0) {
          currentSlidePos = totalSliderItems;
        } else {
          currentSlidePos--;
        }
        moveSliderItem();
      };
      if (sliderPrevBtn) sliderPrevBtn.addEventListener('click', slidePrev);
      const dontHaveExtraItem = totalSliderItems <= 0;
      if (dontHaveExtraItem) {
        if (sliderNextBtn) sliderNextBtn.setAttribute('disabled', '');
        if (sliderPrevBtn) sliderPrevBtn.setAttribute('disabled', '');
      }
      /**AUTO SLIDE */
      let autoSlideInterval;
      const startAutoSlide = () => (autoSlideInterval = setInterval(slideNext, 3000));
      startAutoSlide();
      const stopAutoSlide = () => clearInterval(autoSlideInterval);
      currentSlider.addEventListener('mouseover', stopAutoSlide);
      currentSlider.addEventListener('mouseout', startAutoSlide);
      /**RESPONSIVE */
      window.addEventListener('resize', moveSliderItem);
    };
    for (let i = 0, len = sliders.length; i < len; i++) {
      sliderInit(sliders[i]);
    }
    /**ACCORDION */
    const accordions = document.querySelectorAll('[data-accordion]');
    let lastActiveAccordion;
    const accordionInit = (currentAccordion) => {
      const accordionBtn = currentAccordion.querySelector('[data-accordion-btn]');
      if (accordionBtn) {
        accordionBtn.addEventListener('click', () => {
          if (currentAccordion.classList.contains('active')) {
            currentAccordion.classList.toggle('active');
          } else {
            if (lastActiveAccordion) lastActiveAccordion.classList.remove('active');
            currentAccordion.classList.add('active');
          }
          lastActiveAccordion = currentAccordion;
        });
      }
    };
    for (let i = 0, len = accordions.length; i < len; i++) {
      accordionInit(accordions[i]);
    }
    // Calendario
    const currentDate = document.querySelector('.current-date');
    const daysTag = document.querySelector('.days');
    const date = new Date();
    const currYear = date.getFullYear();
    const currMonth = date.getMonth();
    const months = [
      'Enero',
      'Febrero',
      'Marzo',
      'Abril',
      'Mayo',
      'Junio',
      'Julio',
      'Agosto',
      'Septiembre',
      'Octubre',
      'Noviembre',
      'Diciembre',
    ];
    const renderCalendar = () => {
      if (!currentDate || !daysTag) return;
      const firstDayofMonth = new Date(currYear, currMonth, 1).getDay();
      const lastDateofMonth = new Date(currYear, currMonth + 1, 0).getDate();
      const lastDayofMonth = new Date(currYear, currMonth, lastDateofMonth).getDay();
      const lastDateofLastMonth = new Date(currYear, currMonth, 0).getDate();
      let liTag = '';
      for (let i = firstDayofMonth; i > 0; i--) {
        liTag += `<li class="inactive">${lastDateofLastMonth - i + 1}</li>`;
      }
      for (let i = 1; i <= lastDateofMonth; i++) {
        const isToday = i === date.getDate() && currMonth === new Date().getMonth() && currYear === new Date().getFullYear();
        liTag += `<li class="${isToday ? 'active' : ' '}"> ${i} </li>`;
      }
      for (let i = lastDayofMonth; i < 6; i++) {
        liTag += `<li class="inactive">${i - lastDayofMonth + 1}</li>`;
      }
      currentDate.innerText = `${months[currMonth]} ${currYear}`;
      daysTag.innerHTML = liTag;
    };
    renderCalendar();
    // Funciones de modal de login
    function abrirModal() {
      const modal = document.getElementById('loginModal');
      if (!modal) return;
      const content = modal.querySelector('.modal-content');
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
      modal.style.display = 'flex';
      if (content) {
        content.classList.remove('animate');
        void content.offsetWidth; // Trigger reflow
        content.classList.add('animate');
      }
      if (window.innerWidth <= 768) {
        const headerElement = document.querySelector('.header');
        const headerHeight = headerElement ? headerElement.offsetHeight : 0;
        modal.scrollTo(0, 0);
        modal.style.paddingTop = `${headerHeight + 20}px`;
      }
    }
    function cerrarModal() {
      const modal = document.getElementById('loginModal');
      if (!modal) return;
      document.body.style.overflow = 'auto';
      document.documentElement.style.overflow = 'auto';
      modal.style.display = 'none';
      const errorElement = document.getElementById('error');
      if (errorElement) errorElement.textContent = '';
      if (window.innerWidth <= 768) {
        modal.style.paddingTop = '0';
      }
    }
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        cerrarModal();
        cerrarTodosLosModales();
      }
    });
    // Funciones de autenticaci√≥n
    let usuarioLogueado = null;
// ...existing code...
function verificarSesionActiva() {
  const sesion = localStorage.getItem('sesionUsuario');
  const protectedContent = document.getElementById('protectedContent');
  const protectedContentTurnos = document.getElementById('protectedContentTurnos'); // NUEVO
  const publicContent = document.getElementById('publicContent');
  const userInfo = document.getElementById('userInfo');
  const loginLink = document.getElementById('loginLink');
  const publicShiftsSection = document.getElementById('publicShiftsSection');
  if (sesion) {
    // Usuario logueado
    try {
      usuarioLogueado = JSON.parse(sesion);
      if (protectedContent) protectedContent.classList.remove('hidden');
      if (protectedContentTurnos) protectedContentTurnos.classList.remove('hidden'); // Mostrar la tarjeta
      if (publicContent) publicContent.classList.add('hidden');
      if (publicShiftsSection) publicShiftsSection.classList.add('hidden');
      if (userInfo) userInfo.classList.remove('hidden');
      if (loginLink) loginLink.classList.add('hidden');
      if (document.getElementById('userEmail')) {
        document.getElementById('userEmail').textContent = usuarioLogueado.email;
      }
    } catch (error) {
      // ...manejo de error...
      if (protectedContent) protectedContent.classList.add('hidden');
      if (protectedContentTurnos) protectedContentTurnos.classList.add('hidden'); // Ocultar la tarjeta
      if (publicContent) publicContent.classList.remove('hidden');
      if (publicShiftsSection) publicShiftsSection.classList.remove('hidden');
      if (userInfo) userInfo.classList.add('hidden');
      if (loginLink) loginLink.classList.remove('hidden');
    }
  } else {
    // Usuario no logueado
    if (protectedContent) protectedContent.classList.add('hidden');
    if (protectedContentTurnos) protectedContentTurnos.classList.add('hidden'); // Ocultar la tarjeta
    if (publicContent) publicContent.classList.remove('hidden');
    if (publicShiftsSection) publicShiftsSection.classList.remove('hidden');
    if (userInfo) userInfo.classList.add('hidden');
    if (loginLink) loginLink.classList.remove('hidden');
  }
}
// ...existing code...
    function loguear() {
      const correoInput = document.getElementById('correo');
      const claveInput = document.getElementById('clave');
      const errorElement = document.getElementById('error');
      const loginBtn = document.getElementById('loginBtn');
      if (!correoInput || !claveInput || !errorElement || !loginBtn) return;
      const correo = correoInput.value.trim();
      const clave = claveInput.value.trim();
      if (!correo || !clave) {
        errorElement.textContent = 'Por favor, completa todos los campos';
        return;
      }
      loginBtn.textContent = 'Verificando...';
      loginBtn.disabled = true;
      errorElement.textContent = '';
      google.script.run
        .withSuccessHandler((response) => {
          loginBtn.textContent = 'Entrar';
          loginBtn.disabled = false;
          if (response && response.success) {
            usuarioLogueado = response.user;
            localStorage.setItem('sesionUsuario', JSON.stringify(usuarioLogueado));
            verificarSesionActiva();
            cerrarModal();
            correoInput.value = '';
            claveInput.value = '';
            
            // Aplicar restricciones de √°rea seg√∫n el cargo
            mostrarAreasSegunCargo(usuarioLogueado.cargo);
          } else {
            errorElement.textContent = response ? response.message : 'Error desconocido';
          }
        })
        .withFailureHandler((error) => {
          loginBtn.textContent = 'Entrar';
          loginBtn.disabled = false;
          errorElement.textContent = 'Error de conexi√≥n. Intenta nuevamente.';
          console.error('Login failed:', error);
        })
        .verificarCredenciales(correo, clave);

         google.script.run
    .withSuccessHandler(function(response) {
      if (response.success) {
        // Guardar datos de sesi√≥n
        sessionStorage.setItem('userEmail', response.user.email);
        sessionStorage.setItem('userRole', response.user.cargo);
        
        // Actualizar UI
        document.getElementById('userEmail').textContent = response.user.email;
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('loginLink').classList.add('hidden');
        
        // Cerrar modal de login
        cerrarModal();
        
        // Opcional: Mostrar mensaje de √©xito
        alert('Inicio de sesi√≥n exitoso');
      } else {
        document.getElementById('error').textContent = response.message;
      }
    })
    .withFailureHandler(function(error) {
      document.getElementById('error').textContent = 'Error al intentar iniciar sesi√≥n';
      console.error('Error en login:', error);
    })
    .verificarCredenciales(correo, clave);
}
    
    function cerrarSesion() {
      usuarioLogueado = null;
      localStorage.removeItem('sesionUsuario');
      verificarSesionActiva(); // Re-run to update UI
      cerrarTodosLosModales();
      resetearFormularios();
      // Reset public shifts display to initial message
      if (publicShiftsContainer) {
        publicShiftsContainer.innerHTML = '<p class="no-shifts-message">Por favor, introduce un nombre o documento para buscar turnos.</p>';
      }
    }
    // Configurar event listeners del sistema de turnos
    function configurarEventListeners() {
      // Modal principal
      document.getElementById('programarBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('optionsCustomModal').style.display = 'flex';
      });
      // Cerrar modales
      document.getElementById('closeCustomModal')?.addEventListener('click', cerrarModalPrincipal);
      document.getElementById('closeAreaOptionsModal')?.addEventListener('click', cerrarModalOpciones);
      document.getElementById('closeEmployeeModal')?.addEventListener('click', cerrarModalEmpleados);
      document.getElementById('closeWeeklyModal')?.addEventListener('click', cerrarModalSemanal);
      document.getElementById('closeRangeModal')?.addEventListener('click', cerrarModalRango);
      document.getElementById('closeAnnualModal')?.addEventListener('click', cerrarModalAnual);
      // New edit modal close buttons
      document.getElementById('closeEditWeeklyModal')?.addEventListener('click', cerrarModalEdicionSemanal);
      document.getElementById('closeEditRangeModal')?.addEventListener('click', cerrarModalEdicionRango);
      document.getElementById('closeEditAnnualModal')?.addEventListener('click', cerrarModalEdicionAnual);
      document.getElementById('closeEditSpecificWeekModal')?.addEventListener('click', cerrarModalEdicionSemanaEspecifica);
      // Selecci√≥n de √°rea
      document.querySelectorAll('.option-item').forEach((item) => {
        item.addEventListener('click', function () {
          currentArea = this.getAttribute('data-option');
          const areaNameElement = this.querySelector('.option-name');
          const areaName = areaNameElement ? areaNameElement.textContent : '';
          const areaOptionsTitle = document.getElementById('areaOptionsTitle');
          if (areaOptionsTitle) areaOptionsTitle.textContent = `Opciones de ${areaName}`;
          cerrarModalPrincipal();
          document.getElementById('areaOptionsModal').style.display = 'flex';
        });
      });
      // Botones de opciones
      document.querySelectorAll('.area-option-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          const optionsId = this.id.replace('Btn', 'Options');
          const optionsElement = document.getElementById(optionsId);
          const arrowIcon = this.querySelector('i');
          if (optionsElement && arrowIcon) {
            if (optionsElement.style.display === 'block') {
              optionsElement.style.display = 'none';
              arrowIcon.textContent = '‚ñº';
            } else {
              document.querySelectorAll('.sub-options').forEach((opt) => {
                opt.style.display = 'none';
                const prevBtn = opt.previousElementSibling;
                if (prevBtn) {
                  const prevArrow = prevBtn.querySelector('i');
                  if (prevArrow) prevArrow.textContent = '‚ñº';
                }
              });
              optionsElement.style.display = 'block';
              arrowIcon.textContent = '‚ñ≤';
            }
          }
        });
      });
      // Sub-opciones
      document.querySelectorAll('.sub-option').forEach((option) => {
        option.addEventListener('click', function () {
          const action = this.getAttribute('data-action');
          manejarAccion(action);
        });
      });
      // B√∫squeda de empleados
      document.getElementById('searchBtn')?.addEventListener('click', buscarEmpleados);
      document.getElementById('employeeSearch')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          buscarEmpleados();
        }
      });
      // Search buttons for edit modals
      document.getElementById('searchWeekBtn')?.addEventListener('click', buscarSemanas);
      document.getElementById('editWeeklySearchInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          buscarSemanas();
        }
      });
      document.getElementById('searchRangeBtn')?.addEventListener('click', buscarRangos);
      document.getElementById('searchAnnualBtn')?.addEventListener('click', buscarAnuales);
      // Cerrar modales al hacer clic fuera
      window.addEventListener('click', (e) => {
        if (
          e.target.classList.contains('custom-modal') ||
          e.target.classList.contains('area-options-modal') ||
          e.target.classList.contains('schedule-modal') ||
          e.target.classList.contains('form-modal')
        ) {
          cerrarTodosLosModales();
        }
      });
      configurarModalesAdicionales();
      // Public Shifts Search
      if (publicShiftSearchBtn) {
        publicShiftSearchBtn.addEventListener('click', loadPublicShifts);
      }
      if (publicShiftNameSearchInput) {
        publicShiftNameSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') loadPublicShifts();
        });
      }
      if (publicShiftDocSearchInput) {
        publicShiftDocSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') loadPublicShifts();
        });
      }
    }
    // Configurar modales adicionales
    function configurarModalesAdicionales() {
      document.getElementById('closeAsignarConvencionModal')?.addEventListener('click', () => {
        document.getElementById('asignarConvencionModal').style.display = 'none';
      });
      document.getElementById('cancelAsignarConvencion')?.addEventListener('click', () => {
        document.getElementById('asignarConvencionModal').style.display = 'none';
      });
      document.getElementById('closeAgendarEventoModal')?.addEventListener('click', () => {
        document.getElementById('agendarEventoModal').style.display = 'none';
      });
      document.getElementById('cancelAgendarEvento')?.addEventListener('click', () => {
        document.getElementById('agendarEventoModal').style.display = 'none';
      });
      document.getElementById('asignarConvencionForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        alert('Convenci√≥n asignada correctamente');
        document.getElementById('asignarConvencionModal').style.display = 'none';
        this.reset();
      });
      document.getElementById('agendarEventoForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        alert('Evento agendado correctamente');
        document.getElementById('agendarEventoModal').style.display = 'none';
        this.reset();
      });
      const today = new Date().toISOString().split('T')[0];
      const fechaConvencion = document.getElementById('fechaConvencion');
      const fechaEvento = document.getElementById('fechaEvento');
      if (fechaConvencion) fechaConvencion.min = today;
      if (fechaEvento) fechaEvento.min = today;
    }
    // Funciones de manejo de acciones
   function manejarAccion(action) {
  currentScheduleType = action;
  switch (action) {
    case 'semanal':
    case 'rango-semanas':
    case 'anual':
      cerrarModalOpciones();
      abrirModalEmpleados();
      break;
    case 'editar-semanal':
      cerrarModalOpciones();
      abrirModalEdicionSemanal();
      break;
    case 'editar-rango':
      cerrarModalOpciones();
      abrirModalEdicionRango();
      break;
    case 'editar-anual':
      cerrarModalOpciones();
      abrirModalEdicionAnual(); // Esta funci√≥n deber√≠a mostrar la lista de programaciones anuales
      break;
        case 'asignar-convencion':
          document.getElementById('asignarConvencionModal').style.display = 'flex';
          break;
        case 'nuevo-evento':
          document.getElementById('agendarEventoModal').style.display = 'flex';
          break;
        default:
          alert(`Acci√≥n: ${action}\n√Årea: ${currentArea}`);
      }
    }
    // Funciones de modales
    function cerrarModalPrincipal() {
      document.getElementById('optionsCustomModal').style.display = 'none';
    }
    function cerrarModalOpciones() {
      document.getElementById('areaOptionsModal').style.display = 'none';
    }
    function cerrarModalEmpleados() {
      document.getElementById('employeeModal').style.display = 'none';
    }
    function cerrarModalSemanal() {
      document.getElementById('weeklyScheduleModal').style.display = 'none';
      hideOverHoursAlert('Weekly');
    }
    function cerrarModalRango() {
      document.getElementById('rangeScheduleModal').style.display = 'none';
      hideOverHoursAlert('Range');
    }
    function cerrarModalAnual() {
      document.getElementById('annualScheduleModal').style.display = 'none';
      hideOverHoursAlert('Annual');
    }
    function cerrarTodosLosModales() {
      cerrarModalPrincipal();
      cerrarModalOpciones();
      cerrarModalEmpleados();
      cerrarModalSemanal();
      cerrarModalRango();
      cerrarModalAnual();
      // Check if these modals exist before trying to access style
      const asignarConvencionModal = document.getElementById('asignarConvencionModal');
      const agendarEventoModal = document.getElementById('agendarEventoModal');
      if (asignarConvencionModal) asignarConvencionModal.style.display = 'none';
      if (agendarEventoModal) agendarEventoModal.style.display = 'none';
            // New edit modals
      cerrarModalEdicionSemanal();
      cerrarModalEdicionRango();
      cerrarModalEdicionAnual();
      cerrarModalEdicionSemanaEspecifica();
      hideOverHoursAlert('Weekly');
      hideOverHoursAlert('Range');
      hideOverHoursAlert('Annual');
      hideOverHoursAlert('EditWeekly');
      resetScheduleFormFields(); // Call reset when closing all modals
      hideCustomAlert(); // Ensure the custom alert is also hidden
    }
    function abrirModalEmpleados() {
      document.getElementById('employeeModal').style.display = 'flex';
      cargarEmpleados();
      // No es necesario agregarBotonesDiagnostico() aqu√≠, es una funci√≥n de depuraci√≥n.
    }
    // Funciones para abrir modales de edici√≥n
    function abrirModalEdicionSemanal() {
      document.getElementById('editWeeklyScheduleModal').style.display = 'flex';
      document.getElementById('editSelectedEmployeeInfo').innerHTML = `
      <h3>Editar Programaci√≥n Semanal</h3>
      <p>Busque por documento o nombre para editar programaciones existentes</p>
    `;
      // Limpiar el campo de b√∫squeda al abrir el modal
      const searchInput = document.getElementById('editWeeklySearchInput');
      if (searchInput) searchInput.value = '';
      buscarSemanas(); // Cargar todas las programaciones al inicio
    }
    function abrirModalEdicionRango() {
      document.getElementById('editRangeScheduleModal').style.display = 'flex';
      document.getElementById('editRangeEmployeeInfo').innerHTML = `
      <h3>Editar Programaci√≥n por Rango</h3>
      <p>Busque por empleado para editar rangos existentes</p>
    `;
      // Limpiar el campo de b√∫squeda al abrir el modal
      const searchInput = document.getElementById('editRangeSearch');
      if (searchInput) searchInput.value = '';
      buscarRangos();
    }
    function abrirModalEdicionAnual() {
  document.getElementById('editAnnualScheduleModal').style.display = 'flex';
  document.getElementById('editAnnualEmployeeInfo').innerHTML = `
    <h3>Editar Programaci√≥n Anual</h3>
    <p>Busque por a√±o para editar programaciones existentes</p>
  `;

  // Limpiar el campo de b√∫squeda al abrir el modal
  const searchInput = document.getElementById('editAnnualYearSearch');
  if (searchInput) {
    searchInput.value = '';
  }

  // Cargar todas las programaciones al inicio
  buscarAnuales();
}
    // Funciones para cerrar modales de edici√≥n
    function cerrarModalEdicionSemanal() {
      document.getElementById('editWeeklyScheduleModal').style.display = 'none';
    }
    function cerrarModalEdicionRango() {
      document.getElementById('editRangeScheduleModal').style.display = 'none';
    }
    function cerrarModalEdicionAnual() {
      document.getElementById('editAnnualScheduleModal').style.display = 'none';
    }
    function cerrarModalEdicionSemanaEspecifica() {
      document.getElementById('editSpecificWeekModal').style.display = 'none';
      hideOverHoursAlert('EditWeekly');
    }
    // Funciones de b√∫squeda para edici√≥n
    function buscarSemanas() {
      const busqueda = document.getElementById('editWeeklySearchInput')?.value.trim();
      const tableBody = document.getElementById('editWeeklyTableBody');
      if (!tableBody) {
        console.error('Elemento editWeeklyTableBody no encontrado');
        return;
      }
      tableBody.innerHTML = ` <tr>    <td colspan="3" style="text-align: center;">      <div class="loading">Buscando programaciones...</div>      <div style="display: flex; justify-content: center; margin-top: 20px;">        <!-- From Uiverse.io by Subaashbala -->        <div class="loader">          <div class="modelViewPort">            <div class="eva">              <div class="head">                <div class="eyeChamber">                  <div class="eye"></div>                  <div class="eye"></div>               </div>              </div>              <div class="body">                <div class="hand"></div>               <div class="hand"></div>                <div class="scannerThing"></div>                <div class="scannerOrigin"></div>           <div>            </div>          </div>        </div>      </div>    </td>  </tr>`;
      google.script.run
        .withSuccessHandler((programaciones) => {
          if (!programaciones || programaciones.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3">No se encontraron programaciones</td></tr>';
            return;
          }
          let html = `
          <tr>
            <th>Documento</th>
            <th>Nombre</th>
            <th>Acciones</th>
          </tr>
        `;
          programaciones.forEach((prog) => {
            try {
              html += `
              <tr>
                <td>${prog.empleadoDoc || 'N/A'}</td>
                <td>${prog.empleadoNombre || 'N/A'}</td>
                <td>
                  <button class="btn-edit" onclick="cargarSemanaParaEdicion(
                    ${prog.fila},
                    '${safeString(prog.empleadoDoc)}',
                    '${safeString(prog.empleadoNombre)}',
                    '${safeString(prog.empleadoCargo)}',
                    '${safeString(prog.empleadoArea)}',
                    '${safeString(prog.semanaInicio)}'
                  )">
                    Editar
                  </button>
                </td>
              </tr>
            `;
            } catch (e) {
              console.error('Error generando fila:', e);
            }
          });
          tableBody.innerHTML = html;
        })
        .withFailureHandler((error) => {
          console.error('Error al buscar programaciones:', error);
          tableBody.innerHTML = '<tr><td colspan="3" class="error">Error al cargar programaciones</td></tr>';
        })
        .obtenerProgramaciones('semanal', busqueda, currentArea); // <--- Change here: Pass currentArea
    }
    function safeString(str) {
      return String(str || '')
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n');
    }
    function testObtenerProgramaciones() {
      console.log(google.script.run.obtenerProgramaciones('semanal'));
      console.log(google.script.run.obtenerProgramaciones('rango'));
      console.log(google.script.run.obtenerProgramaciones('anual'));
    }
    function buscarRangos() {
      const busqueda = document.getElementById('editRangeSearch')?.value.trim();
      const tableBody = document.getElementById('editRangeTableBody');
      if (!tableBody) {
        console.error('Elemento editRangeTableBody no encontrado');
        return;
      }
      tableBody.innerHTML = '<tr>    <td colspan="6" style="text-align: center;">      <div class="loading">Buscando programaciones...</div>      <div style="display: flex; justify-content: center; margin-top: 20px;">        <!-- From Uiverse.io by Subaashbala -->        <div class="loader">          <div class="modelViewPort">            <div class="eva">              <div class="head">                <div class="eyeChamber">                  <div class="eye"></div>                  <div class="eye"></div>               </div>              </div>              <div class="body">                <div class="hand"></div>               <div class="hand"></div>                <div class="scannerThing"></div>                <div class="scannerOrigin"></div>           <div>            </div>          </div>        </div>      </div>    </td>  </tr>'; // Increased colspan
      google.script.run
        .withSuccessHandler((programaciones) => {
          if (!programaciones || programaciones.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6">No se encontraron programaciones</td></tr>';
            return;
          }
          // Filtrar por b√∫squeda si existe
          const programacionesFiltradas = busqueda
            ? programaciones.filter(
                (p) =>
                  (p.empleadoDoc && p.empleadoDoc.toLowerCase().includes(busqueda.toLowerCase())) ||
                  (p.empleadoNombre && p.empleadoNombre.toLowerCase().includes(busqueda.toLowerCase())),
              )
            : programaciones;
          let html = `
          <tr>
            <th>Documento</th>
            <th>Nombre</th>
            <th>Fecha Inicio</th>
            <th>Fecha Fin</th>
            <th>Turno</th>
            <th>Acciones</th>
          </tr>
        `;
          programacionesFiltradas.forEach((prog) => {
            html += `
            <tr>
              <td>${prog.empleadoDoc || 'N/A'}</td>
              <td>${prog.empleadoNombre || 'N/A'}</td>
              <td>${formatDate(prog.fechaInicio)}</td>
              <td>${formatDate(prog.fechaFin)}</td>
              <td>${prog.turnoAsignado || 'N/A'}</td>
              <td>
                <button class="btn-edit" onclick="cargarRangoParaEdicion(
                  ${prog.fila},
                  '${safeString(prog.empleadoDoc)}',
                  '${safeString(prog.empleadoNombre)}',
                  '${safeString(prog.empleadoCargo)}',
                  '${safeString(prog.empleadoArea)}'
                )">
                  Editar
                </button>
              </td>
            </tr>
          `;
          });
          tableBody.innerHTML = html;
        })
        .withFailureHandler((error) => {
          console.error('Error al buscar programaciones por rango:', error);
          tableBody.innerHTML = '<tr><td colspan="6" class="error">Error al buscar programaciones</td></tr>';
        })
        .obtenerProgramaciones('rango', busqueda, currentArea); // <--- Change here: Pass currentArea
    }
function buscarAnuales() {
  const a√±oBusqueda = document.getElementById('editAnnualYearSearch')?.value.trim();
  const tableBody = document.getElementById('editAnnualTableBody');
  
  if (!tableBody) {
    console.error('Elemento editAnnualTableBody no encontrado');
    return;
  }

  // Mostrar loader
  tableBody.innerHTML = `<tr>
    <td colspan="7" style="text-align: center;">
      <div class="loading">Buscando programaciones...</div>
      <div class="loader">...</div>
    </td>
  </tr>`;

  google.script.run
    .withSuccessHandler((programaciones) => {
      if (!programaciones || programaciones.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7">No se encontraron programaciones</td></tr>';
        return;
      }

      // Filtrar por a√±o si se especific√≥
      const programacionesFiltradas = a√±oBusqueda
        ? programaciones.filter((p) => p.a√±o && p.a√±o.toString() === a√±oBusqueda)
        : programaciones;

      let html = `
        <tr>
          <th>Documento</th>
          <th>Nombre</th>
          <th>A√±o</th>
          <th>Tipo Turno</th>
          <th>Turno Inicio</th>
          <th>Fijo</th>
          <th>Acciones</th>
        </tr>
      `;

      programacionesFiltradas.forEach((prog) => {
        html += `
          <tr>
            <td>${prog.empleadoDoc || 'N/A'}</td>
            <td>${prog.empleadoNombre || 'N/A'}</td>
            <td>${prog.a√±o || 'N/A'}</td>
            <td>${prog.tipoTurno || 'N/A'}</td>
            <td>${prog.turnoInicio || 'N/A'}</td>
            <td>${prog.fijo ? 'S√≠' : 'No'}</td>
            <td>
              <button class="btn-edit" onclick="cargarAnualParaEdicion(
                ${prog.fila},
                '${safeString(prog.empleadoDoc)}',
                '${safeString(prog.empleadoNombre)}',
                '${safeString(prog.empleadoCargo)}',
                '${safeString(prog.empleadoArea)}'
              )">
                Editar
              </button>
            </td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = html;
    })
    .withFailureHandler((error) => {
      console.error('Error al buscar programaciones anuales:', error);
      tableBody.innerHTML = '<tr><td colspan="7" class="error">Error al buscar programaciones</td></tr>';
    })
    .obtenerProgramaciones('anual', a√±oBusqueda, currentArea); // Pasar currentArea como filtro
}
    // Funciones para cargar datos para edici√≥n
    function cargarSemanaParaEdicion(fila, documento, nombre, cargo, area, semanaInicio) {
      currentEditRow = fila;
      currentEditType = 'semanal';
      selectedEmployee = { documento, nombre, cargo, area };
      console.log(`[cargarSemanaParaEdicion] Solicitando programaci√≥n semanal para fila: ${fila}`);
      // Mostrar informaci√≥n del empleado
      const editWeekEmployeeInfo = document.getElementById('editWeekEmployeeInfo');
      const editWeekInfo = document.getElementById('editWeekInfo');
      if (editWeekEmployeeInfo) {
        editWeekEmployeeInfo.innerHTML = `
        <h3>Editar programaci√≥n</h3>
        <p><strong>Documento:</strong> ${documento}</p>
        <p><strong>Nombre:</strong> ${nombre}</p>
        <p><strong>Cargo:</strong> ${cargo}</p>
        <p><strong>√Årea:</strong> ${area}</p>
      `;
      }
      if (editWeekInfo) {
        editWeekInfo.innerHTML = `
        <p><strong>Semana:</strong> ${semanaInicio}</p>
      `;
      }
      // Cargar los turnos actuales
      google.script.run
        .withSuccessHandler((jsonString) => {
          // Expecting a JSON string
          let programacion = null;
          try {
            programacion = JSON.parse(jsonString);
            console.log('[cargarSemanaParaEdicion] Programaci√≥n recibida y parseada:', programacion);
          } catch (e) {
            console.error('[cargarSemanaParaEdicion] Error al parsear JSON:', e, 'JSON recibido:', jsonString);
            alert('Error al procesar la programaci√≥n recibida. Verifique la consola para m√°s detalles.');
            return;
          }
          if (!programacion) {
            alert('No se pudo cargar la programaci√≥n. Verifique la consola para m√°s detalles.');
            console.error('Programaci√≥n no encontrada o inv√°lida:', programacion);
            return;
          }
          const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
          const turnosBody = document.getElementById('editWeekTurnsBody');
          // CORREGIDO: Usar el textarea correcto para edici√≥n
          const commentInput = document.getElementById('editWeeklyComment');
          if (commentInput && programacion.comentario !== undefined) {
            commentInput.value = programacion.comentario;
          }
          if (!turnosBody) {
            console.error('Elemento editWeekTurnsBody no encontrado');
            alert('Error interno: No se pudo inicializar el formulario de edici√≥n.');
            return;
          }
          turnosBody.innerHTML = ''; // Clear previous content
          const turnOptions = `
          <option value="DESCANSO">Descanso</option>
          <option value="VACACIONES">Vacaciones</option>
          <option value="ANTIGUEDAD">Antig√ºedad</option>
          <option value="CAPACITACION">Capacitaci√≥n</option>
          <option value="INCAPACIDAD">Incapacidad</option>
          <option value="PERMISO">Permiso</option>
          <option value="EVENTO">Evento</option>
          <option value="COMPENSATORIO">Compensatorio</option>
          <option value="BRIGADA">Brigada</option>
          <option value="DOMINGO">Domingo</option>
          <option value="PASANTIA">Pasant√≠a</option>
          <option value="CALAMIDAD">Calamidad</option>
          <option value="AISLAMIENTO">Aislamiento</option>
          <option value="CITA_EPS">Cita EPS</option>
          ${globalTShiftOptionsHtml}
        `;
          dias.forEach((dia) => {
            const row = document.createElement('tr');
            const diaCell = document.createElement('td');
            diaCell.textContent = capitalizeFirstLetter(dia);
            row.appendChild(diaCell);
            const turnCell = document.createElement('td');
            const select = document.createElement('select');
            select.className = 'turn-select';
            select.id = `edit-${dia}`; // IMPORTANT: Add ID here
            select.setAttribute('data-day', dia);
            select.innerHTML = turnOptions;
            // Set the current value
            if (programacion.turnos && programacion.turnos[dia]) {
              select.value = programacion.turnos[dia];
            } else {
              // Default to DESCANSO for Sunday, T1 for others if not found
              select.value = dia === 'domingo' ? 'DESCANSO' : 'T1 ESCENARIO 1 NO DOMINICAL'; // Default to a full shift string
            }
            turnCell.appendChild(select);
            row.appendChild(turnCell);
            turnosBody.appendChild(row);
          });
          // Mostrar el modal de edici√≥n
          document.getElementById('editSpecificWeekModal').style.display = 'flex';
          setupShiftSelectListeners(); // Re-setup listeners for newly created selects
        })
        .withFailureHandler((error) => {
          alert('Error al cargar la programaci√≥n: ' + error);
          console.error('Error en cargarSemanaParaEdicion:', error);
        })
        .obtenerProgramacionPorFila('semanal', fila);
    }
    function cargarRangoParaEdicion(fila, documento, nombre, cargo, area) {
      currentEditRow = fila;
      currentEditType = 'rango';
      
      // Establecer selectedEmployees para la edici√≥n
      selectedEmployees = [{ documento, nombre, cargo, area }];

      google.script.run
        .withSuccessHandler((jsonString) => {
          // Expecting a JSON string
          let programacion = null;
          try {
            programacion = JSON.parse(jsonString);
            console.log('[cargarRangoParaEdicion] Programaci√≥n recibida y parseada:', programacion);
          } catch (e) {
            console.error('[cargarRangoParaEdicion] Error al parsear JSON:', e, 'JSON recibido:', jsonString);
            alert('Error al procesar la programaci√≥n recibida. Verifique la consola para m√°s detalles.');
            return;
          }
          if (!programacion) {
            alert('No se pudo cargar la programaci√≥n por rango.');
            console.error('Programaci√≥n por rango no encontrada o inv√°lida:', programacion);
            return;
          }
          // Mostrar info del empleado en el modal de programaci√≥n por rango (reutilizado para edici√≥n)
          const selectedEmployeeInfoRange = document.getElementById('selectedEmployeeInfoRange');
          if (selectedEmployeeInfoRange) {
            selectedEmployeeInfoRange.innerHTML = `
            <h3>Editando Programaci√≥n por Rango</h3>
            <p><strong>Documento:</strong> ${documento}</p>
            <p><strong>Nombre:</strong> ${nombre}</p>
            <p><strong>Cargo:</strong> ${cargo}</p>
            <p><strong>√Årea:</strong> ${area}</p>
            <p><strong>Fecha creaci√≥n:</strong> ${formatDate(programacion.fechaCreacion)}</p>
          `;
          }
          // Populate the form fields in the original rangeScheduleModal
          const rangeStart = document.getElementById('rangeStart');
          const rangeEnd = document.getElementById('rangeEnd');
          const rangeTurn = document.getElementById('rangeTurn');
          if (rangeStart) rangeStart.value = programacion.fechaInicio;
          if (rangeEnd) rangeEnd.value = programacion.fechaFin;
          if (rangeTurn) rangeTurn.value = programacion.turnoAsignado;
          // Open the original range schedule modal for editing
          document.getElementById('rangeScheduleModal').style.display = 'flex';
          // Close the list of ranges modal
          cerrarModalEdicionRango();
          setupShiftSelectListeners(); // Re-setup listeners for the select
        })
        .withFailureHandler((error) => {
          alert('Error al cargar el rango: ' + error);
          console.error('Error en cargarRangoParaEdicion:', error);
        })
        .obtenerProgramacionPorFila('rango', fila);
    }
    function cargarAnualParaEdicion(fila, documento, nombre, cargo, area) {
      currentEditRow = fila;
      currentEditType = 'anual';
      
      // Establecer selectedEmployees para la edici√≥n
      selectedEmployees = [{ documento, nombre, cargo, area }];

      google.script.run
        .withSuccessHandler((jsonString) => {
          // Expecting a JSON string
          let programacion = null;
          try {
            programacion = JSON.parse(jsonString);
            console.log('[cargarAnualParaEdicion] Programaci√≥n recibida y parseada:', programacion);
          } catch (e) {
            console.error('[cargarAnualParaEdicion] Error al parsear JSON:', e, 'JSON recibido:', jsonString);
            alert('Error al procesar la programaci√≥n recibida. Verifique la consola para m√°s detalles.');
            return;
          }
          if (!programacion) {
            alert('No se pudo cargar la programaci√≥n anual.');
            console.error('Programaci√≥n anual no encontrada o inv√°lida:', programacion);
            return;
          }
          // Mostrar info del empleado en el modal de programaci√≥n anual (reutilizado para edici√≥n)
          const selectedEmployeeInfoAnnual = document.getElementById('selectedEmployeeInfoAnnual');
          if (selectedEmployeeInfoAnnual) {
            selectedEmployeeInfoAnnual.innerHTML = `
            <h3>Editando Programaci√≥n Anual</h3>
            <p><strong>Documento:</strong> ${documento}</p>
            <p><strong>Nombre:</strong> ${nombre}</p>
            <p><strong>Cargo:</strong> ${cargo}</p>
            <p><strong>√Årea:</strong> ${area}</p>
            <p><strong>Fecha creaci√≥n:</strong> ${formatDate(programacion.fechaCreacion)}</p>
          `;
          }
          // Populate the form fields in the original annualScheduleModal
          const annualYear = document.getElementById('annualYear');
          const annualType = document.getElementById('annualType');
          const annualStartTurn = document.getElementById('annualStartTurn');
          const annualFixed = document.getElementById('annualFixed');
          if (annualYear) annualYear.value = programacion.a√±o;
          if (annualType) annualType.value = programacion.tipoTurno;
          if (annualStartTurn) annualStartTurn.value = programacion.turnoInicio;
          if (annualFixed) annualFixed.checked = programacion.fijo;
          // Open the original annual schedule modal for editing
          document.getElementById('annualScheduleModal').style.display = 'flex';
          // Close the list of annual schedules modal
          cerrarModalEdicionAnual();
          setupShiftSelectListeners(); // Re-setup listeners for the select
        })
        .withFailureHandler((error) => {
          alert('Error al cargar la programaci√≥n anual: ' + error);
          console.error('Error en cargarAnualParaEdicion:', error);
        })
        .obtenerProgramacionPorFila('anual', fila);
    }
    // Funciones para guardar ediciones
    function guardarEdicionSemanal() {
      const turnos = {};
      const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
      dias.forEach((dia) => {
        const select = document.getElementById(`edit-${dia}`);
        if (select) {
          turnos[dia] = select.value;
        }
      });
      const btn = event.target;
      btn.textContent = 'Guardando...';
      btn.disabled = true;
        const commentInput = document.getElementById('editWeeklyComment');
      const comentario = commentInput ? commentInput.value.trim() : '';
      if (
        typeof google === 'undefined' ||
        typeof google.script === 'undefined' ||
        typeof google.script.run === 'undefined'
      ) {
        console.error(
          'google.script.run no est√° disponible. Aseg√∫rate de que el script se est√© ejecutando en un entorno de Apps Script.',
        );
        alert('Error interno: No se pudo conectar con el servidor. Intenta recargar la p√°gina.');
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;
        return;
      }
      google.script.run
        .withSuccessHandler((response) => {
          btn.textContent = 'Guardar Cambios';
          btn.disabled = false;
          if (response.success) {
            alert('Cambios guardados correctamente');
            if (response.overHours) {
              showOverHoursAlert(`¬°Atenci√≥n! La programaci√≥n excede las 44 horas semanales. Total calculado: ${response.totalHours} horas.`, 'EditWeekly');
            } else {
              hideOverHoursAlert('EditWeekly');
            }
            cerrarModalEdicionSemanaEspecifica();
            buscarSemanas(); // Refrescar la lista
          } else {
            alert('Error: ' + response.message);
            hideOverHoursAlert('EditWeekly');
          }
        })
        .withFailureHandler((error) => {
          btn.textContent = 'Guardar Cambios';
          btn.disabled = false;
          alert('Error al guardar: ' + error);
          console.error('Error al guardar edici√≥n semanal:', error);
          hideOverHoursAlert('EditWeekly');
        })
        .actualizarProgramacionSemanal(currentEditRow, { ...turnos, comentario });
    }
    function eliminarProgramacionSemanal() {
      if (!confirm('¬øEst√° seguro que desea eliminar esta programaci√≥n?')) return;
      const btn = event.target;
      btn.textContent = 'Eliminando...';
      btn.disabled = true;
      if (
        typeof google === 'undefined' ||
        typeof google.script === 'undefined' ||
        typeof google.script.run === 'undefined'
      ) {
        console.error(
          'google.script.run no est√° disponible. Aseg√∫rate de que el script se est√© ejecutando en un entorno de Apps Script.',
        );
        alert('Error interno: No se pudo conectar con el servidor. Intenta recargar la p√°gina.');
        btn.textContent = 'Eliminar Programaci√≥n';
        btn.disabled = false;
        return;
      }
      google.script.run
        .withSuccessHandler((response) => {
          btn.textContent = 'Eliminar Programaci√≥n';
          btn.disabled = false;
          if (response.success) {
            alert('Programaci√≥n eliminada correctamente');
            cerrarModalEdicionSemanaEspecifica();
            buscarSemanas(); // Refrescar la lista
          } else {
            alert('Error: ' + response.message);
          }
        })
        .withFailureHandler((error) => {
          btn.textContent = 'Eliminar Programaci√≥n';
          btn.disabled = false;
          alert('Error al eliminar: ' + error);
          console.error('Error al eliminar programaci√≥n semanal:', error);
        })
        .eliminarProgramacion('semanal', currentEditRow);
    }
    // Funciones auxiliares
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      // Check if date is valid
      if (isNaN(date.getTime())) {
        console.warn('Invalid date string provided to formatDate:', dateString);
        return 'Fecha inv√°lida';
      }
      return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    // Funciones de empleados mejoradas
    function cargarEmpleados() {
  const tableBody = document.getElementById('employeesTableBody');
  if (!tableBody) return;
  
  tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;"><div class="loading">Cargando empleados...</div></td></tr>';
  
  console.log('Cargando empleados...');
  console.log('√Årea actual:', currentArea);
  
  const filtro = {};
  if (currentArea && currentArea.trim() !== '' && currentArea !== 'todos') {
    filtro.area = currentArea;
  }
  
  console.log('Filtro aplicado:', filtro);

  google.script.run
    .withSuccessHandler((empleados) => {
      console.log('Respuesta recibida:', empleados);
      if (empleados && empleados.error) {
        tableBody.innerHTML = `<tr><td colspan="4" class="error">${empleados.error}</td></tr>`;
        return;
      }
      if (!empleados || empleados.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4">No se encontraron empleados</td></tr>';
        return;
      }
      console.log(`Mostrando ${empleados.length} empleados`);
      mostrarEmpleados(empleados);
    })
    .withFailureHandler((error) => {
      console.error('Error al cargar empleados:', error);
      tableBody.innerHTML = `<tr><td colspan="4" class="error">Error al cargar empleados: ${error}</td></tr>`;
    })
    .obtenerEmpleados(filtro);
}
    function cargarTodosLosEmpleados() {
      const tableBody = document.getElementById('employeesTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = '<tr>    <td colspan="4" style="text-align: center;">      <div class="loading">Buscando programaciones...</div>      <div style="display: flex; justify-content: center; margin-top: 20px;">        <!-- From Uiverse.io by Subaashbala -->        <div class="loader">          <div class="modelViewPort">            <div class="eva">              <div class="head">                <div class="eyeChamber">                  <div class="eye"></div>                  <div class="eye"></div>               </div>              </div>              <div class="body">                <div class="hand"></div>               <div class="hand"></div>                <div class="scannerThing"></div>                <div class="scannerOrigin"></div>           <div>            </div>          </div>        </div>      </div>    </td>  </tr>';
      console.log('Cargando TODOS los empleados sin filtros...');
      google.script.run
        .withSuccessHandler((empleados) => {
          console.log('Respuesta recibida (todos):', empleados);
          if (empleados && empleados.error) {
            console.error('Error del servidor:', empleados);
            tableBody.innerHTML = `
            <tr>
              <td colspan="4" class="error">
                Error: ${empleados.message}
              </td>
            </tr>
          `;
            return;
          }
          if (!empleados || empleados.length === 0) {
            console.log('No se encontraron empleados');
            tableBody.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 20px;">
                No se encontraron empleados en la hoja
              </td>
            </tr>
          `;
            return;
          }
          console.log(`Mostrando ${empleados.length} empleados (sin filtros)`);
          mostrarEmpleados(empleados);
        })
        .withFailureHandler((error) => {
          console.error('Error al cargar todos los empleados:', error);
          tableBody.innerHTML = `
          <tr>
            <td colspan="4" class="error">
              Error de conexi√≥n: ${error}
            </td>
          </tr>
        `;
        })
        .obtenerTodosLosEmpleados();
    }
    function buscarEmpleados() {
      const busqueda = document.getElementById('employeeSearch')?.value.trim();
      const tipo = document.getElementById('searchType')?.value;
      const filtro = {};
      // Solo agregar filtro de √°rea si no est√° vac√≠o y no es "todos"
      if (currentArea && currentArea.trim() !== '' && currentArea !== 'todos') {
        filtro.area = currentArea;
      }
      if (busqueda) {
        if (tipo === 'all') {
          filtro.busqueda = busqueda;
        } else {
          filtro.tipo = tipo;
          filtro.valor = busqueda;
        }
      }
      const tableBody = document.getElementById('employeesTableBody');
      if (tableBody) {
        tableBody.innerHTML = '<tr>    <td colspan="4" style="text-align: center;">      <div class="loading">Buscando programaciones...</div>      <div style="display: flex; justify-content: center; margin-top: 20px;">        <!-- From Uiverse.io by Subaashbala -->        <div class="loader">          <div class="modelViewPort">            <div class="eva">              <div class="head">                <div class="eyeChamber">                  <div class="eye"></div>                  <div class="eye"></div>               </div>              </div>              <div class="body">                <div class="hand"></div>               <div class="hand"></div>                <div class="scannerThing"></div>                <div class="scannerOrigin"></div>           <div>            </div>          </div>        </div>      </div>    </td>  </tr>';
      }
      console.log('Filtro de b√∫squeda:', filtro);
      google.script.run
        .withSuccessHandler(mostrarEmpleados)
        .withFailureHandler((error) => {
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4" class="error">Error en la b√∫squeda</td></tr>';
          }
          console.error('Error en buscarEmpleados:', error);
        })
        .obtenerEmpleados(filtro);
    }
    function cargarEmpleadosConCheckboxes(empleados) {
  const tbody = document.getElementById('employeesTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  empleados.forEach(empleado => {
    const row = document.createElement('tr');
    row.dataset.documento = empleado.documento;
    row.dataset.nombre = empleado.nombre;
    row.dataset.cargo = empleado.cargo || 'Sin cargo';
    row.dataset.area = empleado.area || 'Sin √°rea';
    
    // Nueva estructura del checkbox
    row.innerHTML = `
      <td>
        <div class="container">
          <input type="checkbox" id="cbx-${empleado.documento}" class="employee-checkbox" 
                 data-documento="${empleado.documento}" style="display: none;">
          <label for="cbx-${empleado.documento}" class="check">
            <svg width="18px" height="18px" viewBox="0 0 18 18">
              <path d="M1,9 L1,3.5 C1,2 2,1 3.5,1 L14.5,1 C16,1 17,2 17,3.5 L17,14.5 C17,16 16,17 14.5,17 L3.5,17 C2,17 1,16 1,14.5 L1,9 Z"></path>
              <polyline points="1 9 7 14 15 4"></polyline>
            </svg>
          </label>
        </div>
      </td>
      <td>${empleado.documento}</td>
      <td>${empleado.nombre}</td>
      <td>${empleado.cargo || 'Sin cargo'}</td>
    `;
    
    tbody.appendChild(row);
  });
  
  // Agregar event listeners a los checkboxes
  document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', actualizarContadorSeleccionados);
  });
  
  actualizarContadorSeleccionados();
}
function mostrarEmpleados(empleados) {
  const tableBody = document.getElementById('employeesTableBody');
  if (!tableBody) return;

  if (!empleados || empleados.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="4">No se encontraron empleados</td></tr>';
    return;
  }

  tableBody.innerHTML = ''; // Limpiar tabla existente

  empleados.forEach(empleado => {
    // Verificar que los datos existan y proporcionar valores por defecto si no existen
    const documento = empleado.documento || 'Sin documento';
    const nombre = empleado.nombre || 'Sin nombre';
    const cargo = empleado.cargo || 'Sin cargo';
    const area = empleado.area || 'Sin √°rea';

    const row = document.createElement('tr');
    row.dataset.documento = documento;
    row.dataset.nombre = nombre;
    row.dataset.cargo = cargo;
    row.dataset.area = area;
    
    row.innerHTML = `
      <td>
        <div class="container">
          <input type="checkbox" id="cbx-${documento}" class="employee-checkbox" 
                 data-documento="${documento}" style="display: none;">
          <label for="cbx-${documento}" class="check">
            <svg width="18px" height="18px" viewBox="0 0 18 18">
              <path d="M1,9 L1,3.5 C1,2 2,1 3.5,1 L14.5,1 C16,1 17,2 17,3.5 L17,14.5 C17,16 16,17 14.5,17 L3.5,17 C2,17 1,16 1,14.5 L1,9 Z"></path>
              <polyline points="1 9 7 14 15 4"></polyline>
            </svg>
          </label>
        </div>
      </td>
      <td>${documento}</td>
      <td>${nombre}</td>
      <td>${cargo}</td>
    `;
    
    tableBody.appendChild(row);
  });

  // Agregar event listeners a los checkboxes
  document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', actualizarContadorSeleccionados);
  });
  
  actualizarContadorSeleccionados();
}
    
function seleccionarEmpleados() {
  const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
  selectedEmployees = [];
  
  checkboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    if (row) {
      let area = row.getAttribute('data-area') || '';
      // Si el √°rea est√° vac√≠a o es "Sin √°rea", usar la seleccionada en el modal
      if (!area || area === 'Sin √°rea') {
        area = currentArea;
      }
      const empleado = {
        documento: row.getAttribute('data-documento') || '',
        nombre: row.getAttribute('data-nombre') || '',
        cargo: row.getAttribute('data-cargo') || 'Sin cargo',
        area: area
      };
      selectedEmployees.push(empleado);
    }
  });
  
  console.log('Empleados seleccionados:', selectedEmployees);
  cerrarModalEmpleados();
  
  // Verifica que selectedEmployees no est√© vac√≠o antes de proceder
  if (selectedEmployees.length > 0) {
    switch (currentScheduleType) {
      case 'semanal':
        abrirModalSemanal();
        break;
      case 'rango-semanas':
        abrirModalRango();
        break;
      case 'anual':
        abrirModalAnual();
        break;
    }
  } else {
    showCustomAlert('Por favor, seleccione al menos un empleado.');
  }
}
   function actualizarContadorSeleccionados() {
  const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
  const count = checkboxes.length;
  const countElement = document.getElementById('selectedCount');
  const continueBtn = document.getElementById('continueWithSelectedBtn');
  const disclaimerTxt = continueBtn.parentElement.querySelector('.disclaimer-txt');
  
  if (countElement) {
    countElement.textContent = count;
  }
  
  if (continueBtn) {
    continueBtn.disabled = count === 0;
    if (disclaimerTxt) {
      disclaimerTxt.textContent = count === 0 ? 
        '*Seleccione al menos un empleado' : 
        `*${count} empleado${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
    }
  }
}
function mostrarInfoEmpleados(containerId) {
  const container = document.getElementById(containerId);
  if (!container || !selectedEmployees || !Array.isArray(selectedEmployees) || selectedEmployees.length === 0) {
    console.warn('No hay empleados seleccionados o contenedor no encontrado');
    return;
  }
  
  if (selectedEmployees.length === 1) {
    container.innerHTML = `
      <h3>Empleado Seleccionado</h3>
      <p><strong>Documento:</strong> ${selectedEmployees[0].documento || 'N/A'}</p>
      <p><strong>Nombre:</strong> ${selectedEmployees[0].nombre || 'N/A'}</p>
      <p><strong>Cargo:</strong> ${selectedEmployees[0].cargo || 'Sin cargo'}</p>
      <p><strong>√Årea:</strong> ${selectedEmployees[0].area || 'Sin √°rea'}</p>
    `;
  } else {
    container.innerHTML = `
      <h3>Empleados Seleccionados (${selectedEmployees.length})</h3>
      <p>Se programar√°n turnos para m√∫ltiples empleados</p>
      <div class="selected-employees-list">
        ${selectedEmployees.map(emp => `
          <div class="selected-employee-item">
            <p>${emp.nombre || 'N/A'} (${emp.documento || 'N/A'})</p>
          </div>
        `).join('')}
      </div>
    `;
  }
}
    function configurarEventListenersMultiples() {
      // Bot√≥n para continuar con empleados seleccionados
      const continueBtn = document.getElementById('continueWithSelectedBtn');
      if (continueBtn) {
        continueBtn.addEventListener('click', seleccionarEmpleados);
      }
      
      // Checkbox maestro para seleccionar todos
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.employee-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = this.checked;
          });
          actualizarContadorSeleccionados();
        });
      }
      
      // Botones de selecci√≥n masiva
      const selectAllBtn = document.getElementById('selectAllBtn');
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
          document.querySelectorAll('.employee-checkbox').forEach(cb => {
            cb.checked = true;
          });
          document.getElementById('selectAllCheckbox').checked = true;
          actualizarContadorSeleccionados();
        });
      }
      
      const clearSelectionBtn = document.getElementById('clearSelectionBtn');
      if (clearSelectionBtn) {
        clearSelectionBtn.addEventListener('click', function() {
          document.querySelectorAll('.employee-checkbox').forEach(cb => {
            cb.checked = false;
          });
          document.getElementById('selectAllCheckbox').checked = false;
          actualizarContadorSeleccionados();
        });
      }
    }
    // Funciones de programaci√≥n
    function abrirModalSemanal() {
      resetScheduleFormFields(); // Reset fields before opening
      const modal = document.getElementById('weeklyScheduleModal');
      if (modal) modal.style.display = 'flex';
      // Mostrar info de m√∫ltiples empleados


      mostrarInfoEmpleados('selectedEmployeeInfo');
      const today = new Date();
      const monday = new Date(today.setDate(today.getDate() - today.getDay() + 1));
      const year = monday.getFullYear();
      const week = getWeekNumber(monday);
      const weekStart = document.getElementById('weekStart');
      if (weekStart) weekStart.value = `${year}-W${week.toString().padStart(2, '0')}`;
      hideOverHoursAlert('Weekly'); // Hide alert when opening
      setupShiftSelectListeners(); // Re-setup listeners for selects in this modal
    }
    function abrirModalRango() {
      resetScheduleFormFields(); // Reset fields before opening
      const modal = document.getElementById('rangeScheduleModal');
      if (modal) modal.style.display = 'flex';
      // Mostrar info de m√∫ltiples empleados
      mostrarInfoEmpleados('selectedEmployeeInfoRange');
      const today = new Date().toISOString().split('T')[0];
      const rangeStart = document.getElementById('rangeStart');
      const rangeEnd = document.getElementById('rangeEnd');
      if (rangeStart) rangeStart.min = today;
      if (rangeEnd) rangeEnd.min = today;
      hideOverHoursAlert('Range'); // Hide alert when opening
      setupShiftSelectListeners(); // Re-setup listeners for selects in this modal
    }
    function abrirModalAnual() {
      resetScheduleFormFields(); // Reset fields before opening
      const modal = document.getElementById('annualScheduleModal');
      if (modal) modal.style.display = 'flex';
      // Mostrar info de m√∫ltiples empleados
      mostrarInfoEmpleados('selectedEmployeeInfoAnnual');
      const annualYear = document.getElementById('annualYear');
      if (annualYear) annualYear.value = new Date().getFullYear();
      hideOverHoursAlert('Annual'); // Hide alert when opening
      setupShiftSelectListeners(); // Re-setup listeners for selects in this modal
    }
    function guardarProgramacionSemanal() {
      if (!selectedEmployees || selectedEmployees.length === 0) {
        alert('No hay empleados seleccionados');
        return;
      }

      const weekStartElement = document.getElementById('weekStart');
      const commentElement = document.getElementById('weeklyComment');
      const comment = commentElement ? commentElement.value.trim() : '';

      if (!weekStartElement || !weekStartElement.value) {
        alert('Seleccione una semana');
        return;
      }

      if (!comment && !confirm('¬øDesea continuar sin agregar un comentario?')) {
        return;
      }

      const turnos = {};
      document.querySelectorAll('#weeklyScheduleModal .turn-select').forEach((select) => {
        const day = select.getAttribute('data-day');
        turnos[day] = select.value;
      });

      const btn = event.target;
      btn.textContent = 'Guardando...';
      btn.disabled = true;

      const promesas = selectedEmployees.map(empleado => {
        // CORREGIR: Asegurar que el √°rea est√© presente
        const datos = {
          empleado: {
            ...empleado,
            area: empleado.area && empleado.area !== '' ? empleado.area : currentArea
          },
          semanaInicio: weekStartElement.value,
          turnos: turnos,
          comentario: comment
        };

        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .guardarProgramacionSemanal(datos);
        });
      });

      Promise.all(promesas)
        .then(responses => {
          btn.textContent = 'Guardar Programaci√≥n';
          btn.disabled = false;
          
          const exitosos = responses.filter(r => r.success).length;
          const fallidos = responses.length - exitosos;
          
          if (fallidos === 0) {
            alert(`Programaci√≥n semanal guardada correctamente para ${exitosos} empleado${exitosos > 1 ? 's' : ''}`);
            
            // Verificar si alguno excede horas
            const conExcesoHoras = responses.filter(r => r.overHours);
            if (conExcesoHoras.length > 0) {
              const mensaje = `¬°Atenci√≥n! ${conExcesoHoras.length} empleado${conExcesoHoras.length > 1 ? 's exceden' : ' excede'} las 44 horas semanales.`;
              showOverHoursAlert(mensaje, 'Weekly');
            } else {
              hideOverHoursAlert('Weekly');
            }
            
            cerrarModalSemanal();
            resetearFormularios();
          } else {
            alert(`Se guardaron ${exitosos} empleados correctamente. ${fallidos} fallaron.`);
          }
        })
        .catch(error => {
          btn.textContent = 'Guardar Programaci√≥n';
          btn.disabled = false;
          alert('Error al guardar: ' + error);
          console.error('Error al guardar programaci√≥n semanal m√∫ltiple:', error);
        });
    }
    function verificarHojasExistentes() {
      console.log('Verificando estado de las hojas de turnos...');
      google.script.run
        .withSuccessHandler((resultado) => {
          console.log('=== ESTADO DE LAS HOJAS DE TURNOS ===');
          console.log(resultado);
          if (resultado.success) {
            let mensaje = 'Estado de las hojas de turnos:\n\n';
            resultado.resultados.forEach((r) => {
              mensaje += `${r.hoja}: ${r.mensaje}\n`;
            });
            alert(mensaje);
            // Mostrar en consola para m√°s detalles
            resultado.resultados.forEach((r) => {
              console.log(`Hoja: ${r.hoja}`);
              console.log(`Estado: ${r.mensaje}`);
              if (r.headers) {
                console.log(`Columnas actuales:`, r.headers);
              }
              console.log('---');
            });
          } else {
            alert('Error al verificar hojas: ' + resultado.message);
          }
        })
        .withFailureHandler((error) => {
          console.error('Error al verificar hojas:', error);
          alert('Error al verificar hojas: ' + error);
        })
        .actualizarHojasExistentes();
    }
// Funciones de guardado
function guardarProgramacionRango() {
  if (!selectedEmployees || selectedEmployees.length === 0) {
    alert('No hay empleados seleccionados. Por favor, seleccione al menos un empleado.');
    return;
  }
  const commentElement = document.getElementById('rangeComment');
  const comment = commentElement ? commentElement.value.trim() : '';
  const rangeStartElement = document.getElementById('rangeStart');
  const rangeEndElement = document.getElementById('rangeEnd');
  const rangeTurnElement = document.getElementById('rangeTurn');
  const fechaInicio = rangeStartElement ? rangeStartElement.value : '';
  const fechaFin = rangeEndElement ? rangeEndElement.value : '';
  const turnoAsignado = rangeTurnElement ? rangeTurnElement.value : '';

  if (!fechaInicio || !fechaFin || !turnoAsignado) {
    alert('Complete todos los campos');
    return;
  }

  if (!comment && !confirm('¬øDesea continuar sin agregar un comentario?')) {
    return;
  }

  if (new Date(fechaInicio) >= new Date(fechaFin)) {
    alert('La fecha de inicio debe ser anterior a la fecha de fin');
    return;
  }

  const btn = event.target;
  btn.textContent = 'Guardando...';
  btn.disabled = true;

  // Si estamos editando, usar actualizarProgramacionRango (solo para un empleado)
  if (currentEditRow && currentEditType === 'rango') {
    const datos = {
      empleado: {
        ...selectedEmployees[0],
        area: selectedEmployees[0].area && selectedEmployees[0].area !== '' ? selectedEmployees[0].area : currentArea
      },
      fechaInicio: fechaInicio,
      fechaFin: fechaFin,
      turnoAsignado: turnoAsignado,
      comentario: comment
    };

    google.script.run
      .withSuccessHandler((response) => {
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;
        if (response.success) {
          alert('Programaci√≥n actualizada correctamente');
          if (response.overHours) {
            showOverHoursAlert('El empleado tiene exceso de horas programadas.', 'Range');
          } else {
            hideOverHoursAlert('Range');
          }
          cerrarModalRango();
          buscarRangos(); // Refrescar la lista
        } else {
          alert('Error: ' + response.message);
        }
      })
      .withFailureHandler((error) => {
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;
        alert('Error al guardar: ' + error);
        hideOverHoursAlert('Range');
      })
      .actualizarProgramacionRango(currentEditRow, datos);
  } else {
    const promesas = selectedEmployees.map(empleado => {
      const datos = {
        empleado: {
          ...empleado,
          area: empleado.area && empleado.area !== '' ? empleado.area : currentArea
        },
        fechaInicio: fechaInicio,
        fechaFin: fechaFin,
        turnoAsignado: turnoAsignado,
        comentario: comment
      };

      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .guardarProgramacionRango(datos);
      });
    });
    // Manejar todas las promesas
    Promise.all(promesas)
      .then(responses => {
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;

        const exitosos = responses.filter(r => r.success).length;
        const fallidos = responses.length - exitosos;

        if (fallidos === 0) {
          alert(`Programaci√≥n por rango guardada correctamente para ${exitosos} empleado${exitosos > 1 ? 's' : ''}`);
          
          // Verificar si alguna respuesta tiene overHours
          const conExcesoHoras = responses.filter(r => r.overHours);
          if (conExcesoHoras.length > 0) {
            showOverHoursAlert(`${conExcesoHoras.length} empleado${conExcesoHoras.length > 1 ? 's tienen' : ' tiene'} exceso de horas programadas.`, 'Range');
          } else {
            hideOverHoursAlert('Range');
          }

          cerrarModalRango();
          resetearFormularios();
        } else {
          alert(`Se guardaron ${exitosos} empleados correctamente. ${fallidos} fallaron.`);
        }
      })
      .catch(error => {
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;
        alert('Error al guardar: ' + error);
        console.error('Error al guardar programaci√≥n por rango:', error);
        hideOverHoursAlert('Range');
      });
  }
}

function guardarProgramacionAnual() {
  if (!selectedEmployees || selectedEmployees.length === 0) {
    alert('No hay empleados seleccionados. Por favor, seleccione al menos un empleado.');
    return;
  }

  const annualYearElement = document.getElementById('annualYear');
  const annualTypeElement = document.getElementById('annualType');
  const annualStartTurnElement = document.getElementById('annualStartTurn');
  const annualFixedElement = document.getElementById('annualFixed');
  const commentElement = document.getElementById('annualComment');
  const comment = commentElement ? commentElement.value.trim() : '';
  const a√±o = annualYearElement ? annualYearElement.value : '';
  const tipoTurno = annualTypeElement ? annualTypeElement.value : '';
  const turnoInicio = annualStartTurnElement ? annualStartTurnElement.value : '';
  const fijo = annualFixedElement ? annualFixedElement.checked : false;

  if (!a√±o || !tipoTurno || !turnoInicio) {
    alert('Complete todos los campos');
    return;
  }

    if (!comment && !confirm('¬øDesea continuar sin agregar un comentario?')) {
    return;
  }

  const btn = event.target;
  btn.textContent = 'Guardando...';
  btn.disabled = true;

  // Si estamos editando, usar actualizarProgramacionAnual (solo para un empleado)
  if (currentEditRow && currentEditType === 'anual') {
    const datos = {
      empleado: {
        ...selectedEmployees[0],
        area: selectedEmployees[0].area && selectedEmployees[0].area !== '' ? selectedEmployees[0].area : currentArea
      },
      a√±o: a√±o,
      tipoTurno: tipoTurno,
      turnoInicio: turnoInicio,
      fijo: fijo,
      comentario: comment
    };

    google.script.run
      .withSuccessHandler((response) => {
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;
        if (response.success) {
          alert('Programaci√≥n actualizada correctamente');
          if (response.overHours) {
            showOverHoursAlert('El empleado tiene exceso de horas programadas.', 'Annual');
          } else {
            hideOverHoursAlert('Annual');
          }
          cerrarModalAnual();
          buscarAnuales(); // Refrescar la lista
        } else {
          alert('Error: ' + response.message);
        }
      })
      .withFailureHandler((error) => {
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;
        alert('Error al guardar: ' + error);
        hideOverHoursAlert('Annual');
      })
      .actualizarProgramacionAnual(currentEditRow, datos);
  } else {
    const promesas = selectedEmployees.map(empleado => {
      const datos = {
        empleado: {
          ...empleado,
          area: empleado.area && empleado.area !== '' ? empleado.area : currentArea
        },
        a√±o: a√±o,
        tipoTurno: tipoTurno,
        turnoInicio: turnoInicio,
        fijo: fijo,
        comentario: comment
      };

      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .guardarProgramacionAnual(datos);
      });
    });
    // Manejar todas las promesas
    Promise.all(promesas)
      .then(responses => {
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;

        const exitosos = responses.filter(r => r.success).length;
        const fallidos = responses.length - exitosos;

        if (fallidos === 0) {
          alert(`Programaci√≥n anual guardada correctamente para ${exitosos} empleado${exitosos > 1 ? 's' : ''}`);
          
          // Verificar si alguna respuesta tiene overHours
          const conExcesoHoras = responses.filter(r => r.overHours);
          if (conExcesoHoras.length > 0) {
            showOverHoursAlert(`${conExcesoHoras.length} empleado${conExcesoHoras.length > 1 ? 's tienen' : ' tiene'} exceso de horas programadas.`, 'Annual');
          } else {
            hideOverHoursAlert('Annual');
          }

          cerrarModalAnual();
          resetearFormularios();
        } else {
          alert(`Se guardaron ${exitosos} empleados correctamente. ${fallidos} fallaron.`);
        }
      })
      .catch(error => {
        btn.textContent = 'Guardar Programaci√≥n';
        btn.disabled = false;
        alert('Error al guardar: ' + error);
        console.error('Error al guardar programaci√≥n anual:', error);
        hideOverHoursAlert('Annual');
      });
  }
}
    // Funciones para eliminar programaciones de rango y anual
    function eliminarProgramacionRango() {
      if (!currentEditRow || currentEditType !== 'rango') {
        alert('No hay una programaci√≥n de rango seleccionada para eliminar.');
        return;
      }
      if (!confirm('¬øEst√° seguro que desea eliminar esta programaci√≥n por rango?')) return;
      const btn = event.target;
      btn.textContent = 'Eliminando...';
      btn.disabled = true;
      if (
        typeof google === 'undefined' ||
        typeof google.script === 'undefined' ||
        typeof google.script.run === 'undefined'
      ) {
        console.error(
          'google.script.run no est√° disponible. Aseg√∫rate de que el script se est√© ejecutando en un entorno de Apps Script.',
        );
        alert('Error interno: No se pudo conectar con el servidor. Intenta recargar la p√°gina.');
        btn.textContent = 'Eliminar Programaci√≥n';
        btn.disabled = false;
        return;
      }
      google.script.run
        .withSuccessHandler((response) => {
          btn.textContent = 'Eliminar Programaci√≥n';
          btn.disabled = false;
          if (response.success) {
            alert('Programaci√≥n por rango eliminada correctamente');
            cerrarModalRango(); // Cierra el modal de edici√≥n de rango
            buscarRangos(); // Refrescar la lista de programaciones por rango
            resetearFormularios();
          } else {
            alert('Error: ' + response.message);
          }
        })
        .withFailureHandler((error) => {
          btn.textContent = 'Eliminar Programaci√≥n';
          btn.disabled = false;
          alert('Error al eliminar: ' + error);
          console.error('Error al eliminar programaci√≥n por rango:', error);
        })
        .eliminarProgramacion('rango', currentEditRow);
    }
    function eliminarProgramacionAnual() {
      if (!currentEditRow || currentEditType !== 'anual') {
        alert('No hay una programaci√≥n anual seleccionada para eliminar.');
        return;
      }
      if (!confirm('¬øEst√° seguro que desea eliminar esta programaci√≥n anual?')) return;
      const btn = event.target;
      btn.textContent = 'Eliminando...';
      btn.disabled = true;
      if (
        typeof google === 'undefined' ||
        typeof google.script === 'undefined' ||
        typeof google.script.run === 'undefined'
      ) {
        console.error(
          'google.script.run no est√° disponible. Aseg√∫rate de que el script se est√© ejecutando en un entorno de Apps Script.',
        );
        alert('Error interno: No se pudo conectar con el servidor. Intenta recargar la p√°gina.');
        btn.textContent = 'Eliminar Programaci√≥n';
        btn.disabled = false;
        return;
      }
      google.script.run
        .withSuccessHandler((response) => {
          btn.textContent = 'Eliminar Programaci√≥n';
          btn.disabled = false;
          if (response.success) {
            alert('Programaci√≥n anual eliminada correctamente');
            cerrarModalAnual(); // Cierra el modal de edici√≥n anual
            buscarAnuales(); // Refrescar la lista de programaciones anuales
            resetearFormularios();
          } else {
            alert('Error: ' + response.message);
          }
        })
        .withFailureHandler((error) => {
          btn.textContent = 'Eliminar Programaci√≥n';
          btn.disabled = false;
          alert('Error al eliminar: ' + error);
          console.error('Error al eliminar programaci√≥n anual:', error);
        })
        .eliminarProgramacion('anual', currentEditRow);
    }
    // Funciones auxiliares
    function resetearFormularios() {
      selectedEmployees = null;
      currentScheduleType = '';
      currentEditRow = null; // Reset edit state
      currentEditType = ''; // Reset edit state
      const weeklyComment = document.getElementById('weeklyComment');
  const rangeComment = document.getElementById('rangeComment');
  const annualComment = document.getElementById('annualComment');
  
  if (weeklyComment) weeklyComment.value = '';
  if (rangeComment) rangeComment.value = '';
  if (annualComment) annualComment.value = '';
      const employeeSearch = document.getElementById('employeeSearch');
      const searchType = document.getElementById('searchType');
      const weekStart = document.getElementById('weekStart');
      const rangeStart = document.getElementById('rangeStart');
      const rangeEnd = document.getElementById('rangeEnd');
      const rangeTurn = document.getElementById('rangeTurn');
      const annualYear = document.getElementById('annualYear');
      const annualType = document.getElementById('annualType');
      const annualStartTurn = document.getElementById('annualStartTurn');
      const annualFixed = document.getElementById('annualFixed');
      const editWeeklySearchInput = document.getElementById('editWeeklySearchInput'); // Nuevo input
      const editRangeSearch = document.getElementById('editRangeSearch'); // Nuevo input
      const editAnnualYearSearch = document.getElementById('editAnnualYearSearch'); // Nuevo input
      if (employeeSearch) employeeSearch.value = '';
      if (searchType) searchType.value = 'all';
      if (weekStart) weekStart.value = '';
      if (rangeStart) rangeStart.value = '';
      if (rangeEnd) rangeEnd.value = '';
      if (rangeTurn) rangeTurn.value = 'DESCANSO'; // Default to a non-T shift
      if (annualYear) annualYear.value = new Date().getFullYear();
      if (annualType) annualType.value = 'FIJO';
      if (annualStartTurn) annualStartTurn.value = 'DESCANSO'; // Default to a non-T shift
      if (annualFixed) annualFixed.checked = false;
      if (editWeeklySearchInput) editWeeklySearchInput.value = ''; // Limpiar el nuevo input
      if (editRangeSearch) editRangeSearch.value = ''; // Limpiar el nuevo input
      if (editAnnualYearSearch) editAnnualYearSearch.value = ''; // Limpiar el nuevo input
      // Reset turn selects in weekly schedule modal
      document.querySelectorAll('#weeklyScheduleModal .turn-select').forEach((select) => {
        if (select.getAttribute('data-day') === 'domingo') {
          select.value = 'DESCANSO';
        } else {
          select.value = 'DESCANSO'; // Default to DESCANSO for all days
        }
      });
      // Clear dynamically generated turn selects in edit specific week modal
      const editWeekTurnsBody = document.getElementById('editWeekTurnsBody');
      if (editWeekTurnsBody) {
        editWeekTurnsBody.innerHTML = '';
      }
      hideOverHoursAlert('Weekly');
      hideOverHoursAlert('Range');
      hideOverHoursAlert('Annual');
      hideOverHoursAlert('EditWeekly');
      resetScheduleFormFields(); // Ensure all fields are reset
    }
    // NEW: Function to reset all schedule form fields and hide alerts
    function resetScheduleFormFields() {
      // Reset all turn-select elements to their default values
      document.querySelectorAll('.turn-select').forEach(select => {
        const day = select.getAttribute('data-day');
        if (day === 'domingo') {
          select.value = 'DESCANSO';
        } else {
          select.value = 'DESCANSO'; // Default to DESCANSO for all days
        }
      });
      // Clear date inputs
      const weekStart = document.getElementById('weekStart');
      const rangeStart = document.getElementById('rangeStart');
      const rangeEnd = document.getElementById('rangeEnd');
      const annualYear = document.getElementById('annualYear');
      if (weekStart) weekStart.value = '';
      if (rangeStart) rangeStart.value = '';
      if (rangeEnd) rangeEnd.value = '';
      if (annualYear) annualYear.value = new Date().getFullYear(); // Reset to current year
      // Reset annual type and fixed checkbox
      const annualType = document.getElementById('annualType');
      const annualFixed = document.getElementById('annualFixed');
      if (annualType) annualType.value = 'FIJO';
      if (annualFixed) annualFixed.checked = false;
      // Hide all over hours alerts
      hideOverHoursAlert('Weekly');
      hideOverHoursAlert('Range');
      hideOverHoursAlert('Annual');
      hideOverHoursAlert('EditWeekly');
    }
    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    }







    // Funciones de tabla
    const search = document.querySelector('.input-group input');
    const table_rows = document.querySelectorAll('tbody tr');
    const table_headings = document.querySelectorAll('thead th');
    if (search) {
      search.addEventListener('input', searchTable);
    }
    function searchTable() {
      const tableBody = document.querySelector('#customers_table tbody');
      if (!tableBody) return;
      const rows = Array.from(tableBody.querySelectorAll('tr'));
      const search_data = search.value.toLowerCase();
      rows.forEach((row, i) => {
        const row_text = row.textContent.toLowerCase(); // FIX: Define row_text here
        row.classList.toggle('hide', row_text.indexOf(search_data) < 0);
        row.style.setProperty('--delay', i / 25 + 's');
      });
      document.querySelectorAll('#customers_table tbody tr:not(.hide)').forEach((visible_row, i) => {
        visible_row.style.backgroundColor = i % 2 == 0 ? 'transparent' : '#0000000b';
      });
    }
    table_headings.forEach((head, i) => {
      let sort_asc = true;
      head.onclick = () => {
        table_headings.forEach((head) => head.classList.remove('active'));
        head.classList.add('active');
        document.querySelectorAll('#customers_table td').forEach((td) => td.classList.remove('active'));
        const tableBody = document.querySelector('#customers_table tbody');
        if (!tableBody) return;
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        rows.forEach((row) => {
          row.querySelectorAll('td')[i].classList.add('active');
        });
        head.classList.toggle('asc', sort_asc);
        sort_asc = head.classList.contains('asc') ? false : true;
        sortTable(i, sort_asc);
      };
    });
    function sortTable(column, sort_asc) {
      const tableBody = document.querySelector('#customers_table tbody');
      if (!tableBody) return;
      const rows = Array.from(tableBody.querySelectorAll('tr'));
      rows
        .sort((a, b) => {
          const first_row = a.querySelectorAll('td')[column].textContent.toLowerCase();
          const second_row = b.querySelectorAll('td')[column].textContent.toLowerCase();
          return sort_asc ? (first_row < second_row ? 1 : -1) : first_row < second_row ? -1 : 1;
        })
        .map((sorted_row) => tableBody.appendChild(sorted_row));
    }
    // Funciones de exportaci√≥n
  const pdf_btn = document.querySelector('#toPDF');
const brigadistasTable = document.getElementById('brigadistasTable');
const toPDF = () => {
  if (!customers_table) return;
  // Solo selecciona la tabla de brigadistas, no el main.table completo
  const brigadistasTable = document.getElementById('brigadistasTable');
  if (!brigadistasTable) return;
  const html_code = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Brigadistas</title>
      <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #333; padding: 8px; font-size: 12px; }
        th { background: #1976d2; color: #fff; }
      </style>
    </head>
    <body>
      <h2>Brigadistas</h2>
      ${brigadistasTable.outerHTML}
    </body>
    </html>
  `;
  const new_window = window.open('', '', 'width=900,height=700');
  if (new_window) {
    new_window.document.write(html_code);
    new_window.document.close();
    new_window.print();
  }
};
if (pdf_btn) {
  pdf_btn.addEventListener('click', toPDF);
}
    const json_btn = document.querySelector('#toJSON');
    const toJSON = (table) => {
      const table_data = [];
      const t_head = [];
      const t_headings = table.querySelectorAll('th');
      const t_rows = table.querySelectorAll('tbody tr');
      for (const t_heading of t_headings) {
        const actual_head = t_heading.textContent.trim().split(' ');
        t_head.push(
          actual_head
            .splice(0, actual_head.length - 1)
            .join(' ')
            .toLowerCase(),
        );
      }
      t_rows.forEach((row) => {
        const row_object = {};
        const t_cells = row.querySelectorAll('td');
        // Adjust column mapping based on your new table structure
        row_object['cedula'] = t_cells[0] ? t_cells[0].textContent.trim() : '';
        row_object['nombre'] = t_cells[1] ? t_cells[1].textContent.trim() : '';
        row_object['proceso'] = t_cells[2] ? t_cells[2].textContent.trim() : '';
     

        row_object['telefono'] = t_cells[5] ? t_cells[5].textContent.trim() : '';
        table_data.push(row_object);
      });
      return JSON.stringify(table_data, null, 4);
    };
    if (json_btn) {
      json_btn.addEventListener('click', () => {
        if (customers_table) {
          const json = toJSON(customers_table);
          downloadFile(json, 'json');
        }
      });
    }
    const csv_btn = document.querySelector('#toCSV');
    const toCSV = (table) => {
      const t_heads = table.querySelectorAll('th');
      const tbody_rows = table.querySelectorAll('tbody tr');
      const headings = [...t_heads]
        .map((head) => {
          const actual_head = head.textContent.trim().split(' ');
          return actual_head
            .splice(0, actual_head.length - 1)
            .join(' ')
            .toLowerCase();
        })
        .join(',');
      const table_data = [...tbody_rows]
        .map((row) => {
          const cells = row.querySelectorAll('td');
          // Adjust column mapping based on your new table structure
          const cedula = cells[0] ? cells[0].textContent.replace(/,/g, '.').trim() : '';
          const nombre = cells[1] ? cells[1].textContent.replace(/,/g, '.').trim() : '';
          const proceso = cells[2] ? cells[2].textContent.replace(/,/g, '.').trim() : '';


          const telefono = cells[5] ? cells[5].textContent.replace(/,/g, '.').trim() : '';
          return `${cedula},${nombre},${proceso},${genero},${telefono}`;
        })
        .join('\n');
      return headings + '\n' + table_data;
    };
    if (csv_btn) {
      csv_btn.addEventListener('click', () => {
        if (customers_table) {
          const csv = toCSV(customers_table);
          downloadFile(csv, 'csv', 'brigadistas');
        }
      });
    }
    const excel_btn = document.querySelector('#toEXCEL');
    const toExcel = (table) => {
      const t_heads = table.querySelectorAll('th');
      const tbody_rows = table.querySelectorAll('tbody tr');
      const headings = [...t_heads]
        .map((head) => {
          const actual_head = head.textContent.trim().split(' ');
          return actual_head
            .splice(0, actual_head.length - 1)
            .join(' ')
            .toLowerCase();
        })
        .join('\t');
      const table_data = [...tbody_rows]
        .map((row) => {
          const cells = row.querySelectorAll('td');
          // Adjust column mapping based on your new table structure
          const cedula = cells[0] ? cells[0].textContent.trim() : '';
          const nombre = cells[1] ? cells[1].textContent.trim() : '';
          const proceso = cells[2] ? cells[2].textContent.trim() : '';


          const telefono = cells[5] ? cells[5].textContent.trim() : '';
          return `${cedula}\t${nombre}\t${proceso}\t${genero}\t${telefono}`;
        })
        .join('\n');
      return headings + '\n' + table_data;
    };
    if (excel_btn) {
      excel_btn.addEventListener('click', () => {
        if (customers_table) {
          const excel = toExcel(customers_table);
          downloadFile(excel, 'excel');
        }
      });
    }
    const downloadFile = (data, fileType, fileName = '') => {
      const a = document.createElement('a');
      a.download = fileName;
      const mime_types = {
        json: 'application/json',
        csv: 'text/csv',
        excel: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      };
      a.href = `data:${mime_types[fileType]};charset=utf-8,${encodeURIComponent(data)}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };
    function showTable() {
      const table = document.getElementById('customers_table');
      const tableBody = document.querySelector('.table__body');
      const closeBtn = document.querySelector('.close-table-btn');
      const showBtn = document.querySelector('.show-table-btn');
      if (table) table.style.display = 'block';
      if (closeBtn) closeBtn.style.display = 'block';
      if (showBtn) {
        showBtn.style.opacity = '1';
        setTimeout(() => {
          showBtn.style.opacity = '0';
          setTimeout(() => {
            showBtn.style.display = 'none';
          }, 300);
        }, 0);
      }
      if (tableBody) {
        setTimeout(() => {
          tableBody.classList.add('show');
        }, 50);
      }
      loadBrigadistasTable(); // Call to load brigadistas data
    }
    function hideTable() {
      const table = document.getElementById('customers_table');
      const tableBody = document.querySelector('.table__body');
      const closeBtn = document.querySelector('.close-table-btn');
      const showBtn = document.querySelector('.show-table-btn');
      if (tableBody) tableBody.classList.remove('show');
      if (closeBtn) closeBtn.style.display = 'none';
      setTimeout(() => {
        if (table) table.style.display = 'none';
        if (showBtn) {
          showBtn.style.display = 'block';
          setTimeout(() => {
            showBtn.style.opacity = '1';
          }, 10);
        }
      }, 500);
      if (closeBtn) {
        closeBtn.style.background = 'linear-gradient(45deg, #ff0033, #ff6600, #ffcc00)';
        setTimeout(() => {
          closeBtn.style.background = 'linear-gradient(45deg, #6e00ff, #8a2be2, #9400d3)';
        }, 300);
      }
    }
    // Cerrar modal con clic fuera
    window.onclick = (event) => {
      const loginModal = document.getElementById('loginModal');
      const customAlertModal = document.getElementById('customAlertModal');
      const turnosModal = document.getElementById('turnosProgramadosModal');
      if (loginModal && event.target === loginModal) {
        cerrarModal();
      }
      if (customAlertModal && event.target === customAlertModal) {
        hideCustomAlert(); // Allow clicking outside to close custom alert
      }
      if (turnosModal && event.target === turnosModal) {
        cerrarModalTurnosProgramados();
      }
    };
    // Login con Enter
    document.addEventListener('keypress', (event) => {
      const loginModal = document.getElementById('loginModal');
      if (event.key === 'Enter' && loginModal && loginModal.style.display === 'block') {
        loguear();
      }
    });

 function mostrarAreasSegunCargo(cargo) {
  const opcionesAreas = document.querySelectorAll('.option-item');
  
  // Mapeo detallado de cargos a √°reas permitidas
  const areasPermitidas = {
    'COMPLETO': ['todos', 'materias-primas', 'molino', 'cedi', 'empaque', 'pastificio', 
                 'calidad', 'sst', 'info-manufactura', 'almacen-general', 'ingenieria-montaje',
                 'investigacion-desarrollo', 'mantenimiento', 'soporte-adtvo', 'maquinista',
                 'lider-operaciones', 'soporte-servicios-administrativos', 'empacador',
                 'operario-montacarga', 'jefe-ingenieria', 'coordinador-distribucion',
                 'analista-control-gestion', 'produccion', 'gestion-humana', 'mercadeo',
                 'planeacion', 'gestion-ambiental', 'tecnologia', 'gestion-comercial',
                 'gestion-integral'],
    'ANALISTA SEGURIDAD Y SALUD EN EL TRABAJO': ['sst'],
    'AUXILIAR SEGURIDAD Y SALUD EN EL TRABAJO': ['sst'],
    'COORDINADOR INFORMACION MANUFACTURA': ['info-manufactura'],
    'COORDINADOR(A) ALMACEN MATERIAS PRIMAS': ['materias-primas'],
    'COORDINADOR/A ALMAC√âN GENERAL': ['almacen-general'],
    'COORDINADOR/A CENTRO DE DISTRIBUCI√ìN-CEDI': ['cedi'],
    'COORDINADOR/A TURNO MOLINO': ['molino'],
    'DIR.DLLO HUMANO Y SEG. Y SALUD EN TRABAJ': ['sst', 'gestion-humana'],
    'JEFE DE TURNO MOLINO': ['molino'],
    'JEFE DE TURNO PASTIFICIO': ['pastificio'],
    'JEFE MECANICO DE EMPAQUE': ['empaque', 'mantenimiento'],
    'JEFE MOLINERO': ['molino'],
    'JEFE SERVICIOS ADMINISTRATIVOS': ['soporte-servicios-administrativos'],
    'JEFE/A DE ASEGURAMIENTO DE CALIDAD': ['calidad'],
    'JEFE/A DE INGENIER√çA': ['ingenieria-montaje', 'mantenimiento'],
    'JEFE/A DE PRODUCCI√ìN': ['produccion', 'materias-primas', 'molino', 'empaque', 'pastificio'],
    'L√çDER DE OPERACIONES': ['lider-operaciones', 'produccion'],
    'L√çDER DE SALUD Y SEGURIDAD': ['sst']
  };

  // Si el cargo no est√° en el mapeo, no mostrar ning√∫n √°rea
  if (!areasPermitidas[cargo]) {
    opcionesAreas.forEach(area => area.style.display = 'none');
    return;
  }

  // Mostrar/ocultar √°reas seg√∫n los permisos
  opcionesAreas.forEach(area => {
    const areaId = area.getAttribute('data-option');
    if (cargo === 'COMPLETO' || areasPermitidas[cargo].includes(areaId)) {
      area.style.display = 'flex'; // Mostrar el √°rea
    } else {
      area.style.display = 'none'; // Ocultar el √°rea
    }
  });
}
    // New functions for the custom alert modal
    function showCustomAlert(message, linkUrl) {
      const modal = document.getElementById('customAlertModal');
      const messageP = document.getElementById('customAlertMessage');
      const linkA = document.getElementById('customAlertLink');
      if (modal && messageP && linkA) {
        messageP.textContent = message;
        linkA.href = linkUrl;
        linkA.textContent = "Registrar Horas Extras Aqu√≠"; // Ensure link text is always set
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling behind modal
      }
    }
    function hideCustomAlert() {
      const modal = document.getElementById('customAlertModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto'; // Restore scrolling
      }
    }
    // Functions for displaying over hours alert (now uses customAlertModal)
    function showOverHoursAlert(message, modalType) {
      const appsheetLink = "https://www.appsheet.com/start/560d1208-9593-4878-9864-044f1fefee6c?platform=desktop#appName=RegistroHorasExtrasrespuestas-962923930&vss=H4sIAAAAAAAAA63Pu07DMBQG4FeJzpxIDQmq6xUxVIgOBbFghuP4WLJI7MgXoIr87jgUxMREt3ORPv3_Am-G3h8iDq_An5ff7Y5OwGER8HiaSQAXcONs9G4UUAs44HQ-HinMiULEUCmqtPNTGtEbV7UCMuSX-keMFIAv_wX5pRPWYBTZaLQhv-qrVdRvqbxXpxz-ViDXMKWIcqSvmqtiwt7eKhPvnSp79IlqiB5twCEaZ_eqiJ28xu1mwxrc7dqm75gsU68btWXsisl2kF0PORdduyEFUk-l-EUKr-E-ZrTqHE_jGCh_AsGOPFEJAgAA&view=Respuestas%20de%20formulario%201";
      showCustomAlert(message, appsheetLink);
    }
    function hideOverHoursAlert(modalType) { // modalType is now just for context
      hideCustomAlert();
    }
    // Event handler for shift select changes
    function handleShiftSelectChange(event) {
      const selectedValue = event.target.value;
      // No need for modalType here, as it's a global alert now
      hideCustomAlert(); // Always hide previous custom alert
      if (selectedValue.includes('EXTRA')) {
        showOverHoursAlert('¬°Atenci√≥n! Este turno incluye operaci√≥n dominical. Por favor, registra las horas extras si aplica.', 'Dominical'); // Pass a dummy modalType
      }
    }
    // Function to set up event listeners for all .turn-select elements
    function setupShiftSelectListeners() {
      document.querySelectorAll('.turn-select').forEach(select => {
        select.removeEventListener('change', handleShiftSelectChange); // Prevent duplicate listeners
        select.addEventListener('change', handleShiftSelectChange);
      });
    }
    // Override modal opening functions to re-attach listeners after content is loaded
    // Modificar la funci√≥n abrirModalSemanal para usar solo el nuevo calendario
const abrirModalSemanalOriginal = abrirModalSemanal;
abrirModalSemanal = function() {
    abrirModalSemanalOriginal();
    
    // Agregar bot√≥n de calendario MEJORADO
    setTimeout(function() {
        const selectorSemana = document.querySelector('.week-selector');
        if (selectorSemana && !selectorSemana.querySelector('.calendar-picker-btn')) {
            const botonCalendario = document.createElement('button');
            botonCalendario.type = 'button';
            botonCalendario.className = 'calendar-picker-btn';
            botonCalendario.innerHTML = 'üìÖ Abrir Calendario de Turnos';
            botonCalendario.onclick = abrirModalCalendario;
            
            // Agregar descripci√≥n
            const descripcion = document.createElement('small');
            descripcion.style.display = 'block';
            descripcion.style.marginTop = '5px';
            descripcion.style.color = '#666';
            descripcion.textContent = 'Selecciona semanas y configura turnos visualmente';
            
            selectorSemana.appendChild(botonCalendario);
            selectorSemana.appendChild(descripcion);
        }
    }, 100);
};
    const originalAbrirModalRango = abrirModalRango;
    abrirModalRango = function() {
      originalAbrirModalRango();
      setupShiftSelectListeners();
    };
    const originalAbrirModalAnual = abrirModalAnual;
    abrirModalAnual = function() {
      originalAbrirModalAnual();
      setupShiftSelectListeners();
    };
    const originalCargarSemanaParaEdicion = cargarSemanaParaEdicion;
    cargarSemanaParaEdicion = function(fila, documento, nombre, cargo, area, semanaInicio) {
      originalCargarSemanaParaEdicion(fila, documento, nombre, cargo, area, semanaInicio);
      // Delay setup to ensure dynamically added elements are rendered
      setTimeout(setupShiftSelectListeners, 100);
    };
    const originalCargarRangoParaEdicion = cargarRangoParaEdicion;
    cargarRangoParaEdicion = function(fila, documento, nombre, cargo, area) {
      originalCargarRangoParaEdicion(fila, documento, nombre, cargo, area);
      setTimeout(setupShiftSelectListeners, 100);
    };
    const originalCargarAnualParaEdicion = cargarAnualParaEdicion;
    cargarAnualParaEdicion = function(fila, documento, nombre, cargo, area) {
      originalCargarAnualParaEdicion(fila, documento, nombre, cargo, area);
      setTimeout(setupShiftSelectListeners, 100);
    };
    // New function to load and display public shifts
  function renderPublicShiftsTable(turnos) {
  const container = document.getElementById('publicShiftsContainer');
  if (!container) return;

  // Define los iconos por columna
  const iconMap = {
    nombre: '<ion-icon name="person-outline" class="icon-table"></ion-icon>',
    documento: '<ion-icon name="card-outline" class="icon-table"></ion-icon>',
    cargo: '<ion-icon name="briefcase-outline" class="icon-table"></ion-icon>',
    area: '<ion-icon name="business-outline" class="icon-table"></ion-icon>',
    lunes: '<ion-icon name="calendar-outline" class="icon-table"></ion-icon>',
    martes: '<ion-icon name="calendar-outline" class="icon-table"></ion-icon>',
    miercoles: '<ion-icon name="calendar-outline" class="icon-table"></ion-icon>',
    jueves: '<ion-icon name="calendar-outline" class="icon-table"></ion-icon>',
    viernes: '<ion-icon name="calendar-outline" class="icon-table"></ion-icon>',
    sabado: '<ion-icon name="calendar-outline" class="icon-table"></ion-icon>',
    domingo: '<ion-icon name="calendar-outline" class="icon-table"></ion-icon>',
    periodo: '<ion-icon name="time-outline" class="icon-table"></ion-icon>',
    comentario: '<ion-icon name="chatbubble-ellipses-outline" class="icon-table"></ion-icon>',
  };

  // Renderiza el thead con iconos SIEMPRE
  let html = `
    <table class="public-shifts-table">
      <thead>
        <tr>
          <th>${iconMap.nombre} Nombre</th>
          <th>${iconMap.documento} Documento</th>
          <th>${iconMap.cargo} Cargo</th>
          <th>${iconMap.area} √Årea</th>
          <th>${iconMap.lunes} Lunes</th>
          <th>${iconMap.martes} Martes</th>
          <th>${iconMap.miercoles} Mi√©rcoles</th>
          <th>${iconMap.jueves} Jueves</th>
          <th>${iconMap.viernes} Viernes</th>
          <th>${iconMap.sabado} S√°bado</th>
          <th>${iconMap.domingo} Domingo</th>
          <th>${iconMap.periodo} Periodo</th>
          <th>${iconMap.comentario} Comentario</th>
        </tr>
      </thead>
      <tbody id="publicShiftsTableBody">
  `;

  if (!turnos || turnos.length === 0) {
    html += `<tr><td colspan="13" class="no-shifts-message">No se encontraron turnos.</td></tr>`;
  } else {
    turnos.forEach(turno => {
      html += `
        <tr>
          <td>${turno.nombre || ''}</td>
          <td>${turno.documento || ''}</td>
          <td>${turno.cargo || ''}</td>
          <td>${turno.area || ''}</td>
          <td>${turno.lunes || ''}</td>
          <td>${turno.martes || ''}</td>
          <td>${turno.miercoles || ''}</td>
          <td>${turno.jueves || ''}</td>
          <td>${turno.viernes || ''}</td>
          <td>${turno.sabado || ''}</td>
          <td>${turno.domingo || ''}</td>
          <td>${turno.periodo || ''}</td>
          <td>${turno.comentario || ''}</td>
        </tr>
      `;
    });
  }

  html += `
      </tbody>
    </table>
  `;

  container.innerHTML = html;
}
function loadPublicShifts() {
  if (!publicShiftsContainer) return;
  const nameSearch = publicShiftNameSearchInput ? publicShiftNameSearchInput.value.trim() : '';
  const docSearch = publicShiftDocSearchInput ? publicShiftDocSearchInput.value.trim() : '';
  if (!nameSearch && !docSearch) {
    publicShiftsContainer.innerHTML = '<p class="no-shifts-message">Por favor, introduce un nombre o documento para buscar turnos.</p>';
    return;
  }
  publicShiftsContainer.innerHTML = '<p class="no-shifts-message">Cargando turnos...</p>';
  const filtro = {
    nombre: nameSearch,
    documento: docSearch,
  };
  google.script.run
    .withSuccessHandler(renderPublicShiftsTable)
    .withFailureHandler((error) => {
      if (publicShiftsContainer) {
        publicShiftsContainer.innerHTML = `<p class="no-shifts-message error">Error al cargar turnos: ${error.message || error}</p>`;
      }
      console.error('Error al cargar turnos p√∫blicos:', error);
    })
    .getPublicShifts(filtro);
}
    // NEW FUNCTION: Load Brigadistas data into the table
 function loadBrigadistasTable() {
  const tableBody = document.querySelector('#brigadistasTable tbody');
  if (!tableBody) return;
  tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center;">Cargando Brigadistas...</td></tr>';

  google.script.run
    .withSuccessHandler((brigadistas) => {
      if (!brigadistas || brigadistas.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center;">No hay brigadistas registrados.</td></tr>';
        return;
      }
      let html = '';
      for (const b of brigadistas) {
        html += `
          <tr>
            <td style="font-weight:600;">${b.nombre || ''}</td>
            <td>${b.proceso || ''}</td>
            <td>
              <span class="badge badge-altura">${b.alturasConfinados || 'No'}</span>
            </td>
            <td>
              <span class="icon-phone">üìû</span>
              <a href="tel:${b.telefono || ''}" style="color:#4cafef;text-decoration:none;">${b.telefono || ''}</a>
            </td>
            <td class="turno-cell">${b.turnos.lunes || '-'}</td>
            <td class="turno-cell">${b.turnos.martes || '-'}</td>
            <td class="turno-cell">${b.turnos.miercoles || '-'}</td>
            <td class="turno-cell">${b.turnos.jueves || '-'}</td>
            <td class="turno-cell">${b.turnos.viernes || '-'}</td>
            <td class="turno-cell">${b.turnos.sabado || '-'}</td>
            <td class="turno-cell">${b.turnos.domingo || '-'}</td>
          </tr>
        `;
      }
      tableBody.innerHTML = html;
    })
    .withFailureHandler((error) => {
      tableBody.innerHTML = `<tr><td colspan="13" style="text-align: center; color: #f44336;">Error: ${error}</td></tr>`;
    })
    .getBrigadistasData();
}
    google.script.run
      .withSuccessHandler((response) => console.log(response))
      .withFailureHandler((error) => console.error(error))
      .testConnection();

      // Create particle effect
        const particlesContainer = document.getElementById('particles-container');
        const particleCount = 80;
        
        // Create particles
        for (let i = 0; i < particleCount; i++) {
            createParticle();
        }
        
        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // Random size (small)
            const size = Math.random() * 3 + 1;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            
            // Initial position
            resetParticle(particle);
            
            particlesContainer.appendChild(particle);
            
            // Animate
            animateParticle(particle);
        }
        
        function resetParticle(particle) {
            // Random position
            const posX = Math.random() * 100;
            const posY = Math.random() * 100;
            
            particle.style.left = `${posX}%`;
            particle.style.top = `${posY}%`;
            particle.style.opacity = '0';
            
            return {
                x: posX,
                y: posY
            };
        }
        
        function animateParticle(particle) {
            // Initial position
            const pos = resetParticle(particle);
            
            // Random animation properties
            const duration = Math.random() * 10 + 10;
            const delay = Math.random() * 5;
            
            // Animate with GSAP-like timing
            setTimeout(() => {
                particle.style.transition = `all ${duration}s linear`;
                particle.style.opacity = Math.random() * 0.3 + 0.1;
                
                // Move in a slight direction
                const moveX = pos.x + (Math.random() * 20 - 10);
                const moveY = pos.y - Math.random() * 30; // Move upwards
                
                particle.style.left = `${moveX}%`;
                particle.style.top = `${moveY}%`;
                
                // Reset after animation completes
                setTimeout(() => {
                    animateParticle(particle);
                }, duration * 1000);
            }, delay * 1000);
        }
        
        // Mouse interaction
        document.addEventListener('mousemove', (e) => {
            // Create particles at mouse position
            const mouseX = (e.clientX / window.innerWidth) * 100;
            const mouseY = (e.clientY / window.innerHeight) * 100;
            
            // Create temporary particle
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // Small size
            const size = Math.random() * 4 + 2;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            
            // Position at mouse
            particle.style.left = `${mouseX}%`;
            particle.style.top = `${mouseY}%`;
            particle.style.opacity = '0.6';
            
            particlesContainer.appendChild(particle);
            
            // Animate outward
            setTimeout(() => {
                particle.style.transition = 'all 2s ease-out';
                particle.style.left = `${mouseX + (Math.random() * 10 - 5)}%`;
                particle.style.top = `${mouseY + (Math.random() * 10 - 5)}%`;
                particle.style.opacity = '0';
                
                // Remove after animation
                setTimeout(() => {
                    particle.remove();
                }, 2000);
            }, 10);
            
            // Subtle movement of gradient spheres
            const spheres = document.querySelectorAll('.gradient-sphere');
            const moveX = (e.clientX / window.innerWidth - 0.5) * 5;
            const moveY = (e.clientY / window.innerHeight - 0.5) * 5;
            
            spheres.forEach(sphere => {
                const currentTransform = getComputedStyle(sphere).transform;
                sphere.style.transform = `translate(${moveX}px, ${moveY}px)`;
            });
        });

        const themes = [
  { background: "#1A1A2E", color: "#FFFFFF", primaryColor: "#0F3460" },
  { background: "#461220", color: "#FFFFFF", primaryColor: "#E94560" },
  { background: "#192A51", color: "#FFFFFF", primaryColor: "#967AA1" },
  { background: "#F7B267", color: "#000000", primaryColor: "#F4845F" },
  { background: "#F25F5C", color: "#000000", primaryColor: "#642B36" },
  { background: "#231F20", color: "#FFF", primaryColor: "#BB4430" }
];

const setTheme = (theme) => {
  const root = document.querySelector(":root");
  root.style.setProperty("--background", theme.background);
  root.style.setProperty("--color", theme.color);
  root.style.setProperty("--primary-color", theme.primaryColor);
};

const displayThemeButtons = () => {
  const btnContainer = document.querySelector(".theme-btn-container");
  themes.forEach((theme) => {
    const div = document.createElement("div");
    div.className = "theme-btn";
    div.style.cssText = `background: ${theme.background}; width: 25px; height: 25px`;
    btnContainer.appendChild(div);
    div.addEventListener("click", () => setTheme(theme));
  });
};


// Agregar esta funci√≥n al inicio del archivo
document.addEventListener('DOMContentLoaded', function() {
  // Verificar si el usuario est√° logueado
  const userEmail = sessionStorage.getItem('userEmail');
  const userInfo = document.getElementById('userInfo');
  const loginLink = document.getElementById('loginLink');
  
  if (userEmail) {
    // Usuario logueado
    if (userInfo && loginLink) {
      userInfo.classList.remove('hidden');
      loginLink.classList.add('hidden');
      document.getElementById('userEmail').textContent = userEmail;
    }
  } else {
    // Usuario no logueado
    if (userInfo && loginLink) {
      userInfo.classList.add('hidden');
      loginLink.classList.remove('hidden');
    }
  }
});
// Funci√≥n auxiliar para formatear el horario
function formatearHorario(horario) {
  if (!horario) return '-';
  return Object.entries(horario)
    .map(([dia, valor]) => `${dia}: ${valor}`)
    .join('<br>');
}

// Funci√≥n para cerrar el modal
function cerrarModalTurno(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
  }
}


function cargarAreasPermitidas(turno) {
  const selectId = `areaFilterT${turno.substring(1)}`;
  google.script.run
    .withSuccessHandler(areas => {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">Todas las √°reas</option>';
      areas.forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        select.appendChild(option);
      });
    })
    .obtenerAreasPermitidas(usuarioLogueado);
}

function cargarPersonalEnTurno(turno) {
  const tableId = `turno${turno.substring(1)}Table`;
  const areaSelect = document.getElementById(`areaFilterT${turno.substring(1)}`);
  const areaSeleccionada = areaSelect.value;

  google.script.run
    .withSuccessHandler(personal => {
      const tbody = document.getElementById(tableId);
      tbody.innerHTML = '';

      personal.forEach(empleado => {
        if (!areaSeleccionada || empleado.area === areaSeleccionada) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${empleado.nombre}</td>
            <td>${empleado.documento}</td>
            <td>${empleado.cargo}</td>
            <td>${empleado.area}</td>
            <td>${empleado.horario.Lunes || '-'}</td>
            <td>${empleado.horario.Martes || '-'}</td>
            <td>${empleado.horario.Miercoles || '-'}</td>
            <td>${empleado.horario.Jueves || '-'}</td>
            <td>${empleado.horario.Viernes || '-'}</td>
            <td>${empleado.horario.Sabado || '-'}</td>
            <td>${empleado.horario.Domingo || '-'}</td>
          `;
          tbody.appendChild(tr);
        }
      });
    })
    .withFailureHandler(error => {
      console.error('Error al cargar personal:', error);
      alert('Error al cargar el personal en turno');
    })
    .obtenerPersonalEnTurno(turno, usuarioLogueado);
}
function mostrarDetallesTurno(btn, detalles) {
  const detallesDiv = btn.nextElementSibling;
  if (detallesDiv.style.display === 'none') {
    detallesDiv.style.display = 'block';
    btn.textContent = 'Ocultar Detalles';
  } else {
    detallesDiv.style.display = 'none';
    btn.textContent = 'Ver Detalles';
  }
}

// Agregar event listeners para los botones de cerrar
document.addEventListener('DOMContentLoaded', function() {
  ['1', '2', '3'].forEach(turno => {
    document.getElementById(`closeTurno${turno}Modal`)?.addEventListener('click', () => {
      cerrarModalTurno(`turno${turno}Modal`);
    });
  });
});



displayThemeButtons();


function abrirModalTurnosProgramados() {
  const modal = document.getElementById('turnosProgramadosModal');
  modal.style.display = 'flex';
  cargarAreas();
  cargarTurnosProgramados();
}

function cerrarModalTurnosProgramados() {
  const modal = document.getElementById('turnosProgramadosModal');
  modal.style.display = 'none';
}

function cargarAreas() {
  const areaSelect = document.getElementById('areaFilter');
  // Lista de √°reas basada en los datos proporcionados
  const areas = [
    'materias-primas', 'molino', 'cedi',
    'calidad', 'sst', 'almacen-general',
    'ingenieria-montaje', 'coordinador-distribucion', 'produccion', 'analista-control-gestion', 'gestion-ambiental'
    // ... resto de √°reas
  ];
  
  areaSelect.innerHTML = '<option value="">Todas las √°reas</option>';
  areas.forEach(area => {
    areaSelect.innerHTML += `<option value="${area}">${area.replace('-', ' ').toUpperCase()}</option>`;
  });
}

function filtrarTurnosPorArea() {
  const area = document.getElementById('areaFilter').value;
  cargarTurnosProgramados(area);
}

function cargarTurnosProgramados(area = '') {
  google.script.run
    .withSuccessHandler(mostrarTurnos)
    .withFailureHandler(error => console.error('Error:', error))
    .obtenerTodosTurnos(area);
}

function mostrarTurnos(turnos) {
  const tbody = document.getElementById('turnosProgramadosTableBody');
  tbody.innerHTML = '';

  turnos.forEach(turno => {
    // Detectar tipo de turno
    let tipoTurno = '';
    if (turno.periodo && turno.periodo.startsWith('A√±o')) {
      tipoTurno = '<span style="font-size:1.1em; font-weight:bold; color:#007bff;">ANUAL</span>';
    } else if (turno.periodo && turno.periodo.includes('-')) {
      tipoTurno = '<span style="font-size:1.1em; font-weight:bold; color:#28a745;">RANGO</span>';
    } else {
      tipoTurno = '<span style="font-size:1.1em; font-weight:bold; color:#ff9800;">SEMANAL</span>';
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${turno.nombre}</td>
      <td>${turno.documento}</td>
      <td>${turno.cargo}</td>
      <td>${turno.area}</td>
      <td>${turno.lunes}</td>
      <td>${turno.martes}</td>
      <td>${turno.miercoles}</td>
      <td>${turno.jueves}</td>
      <td>${turno.viernes}</td>
      <td>${turno.sabado}</td>
      <td>${turno.domingo}</td>
      <td>${tipoTurno}</td>
      <td>${turno.periodo || '-'}</td>
      <td>${turno.comentario ? `<div class="comment-display">${turno.comentario}</div>` : '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}
// ...existing code...
// ...existing code...
// ...existing code...
// ...existing code...
function exportarTurnosAPDF() {
  const area = document.getElementById('areaFilter').value;
  const areaText = area ? `√Årea: ${area.toUpperCase()}` : 'Todas las √°reas';

  const rows = Array.from(document.querySelectorAll('#turnosProgramadosTableBody tr'));
  const body = [
    [
      { text: 'Nombre', style: 'tableHeader' },
      { text: 'Documento', style: 'tableHeader' },
      { text: 'Cargo', style: 'tableHeader' },
      { text: '√Årea', style: 'tableHeader' },
      { text: 'Lunes', style: 'tableHeader' },
      { text: 'Martes', style: 'tableHeader' },
      { text: 'Mi√©rcoles', style: 'tableHeader' },
      { text: 'Jueves', style: 'tableHeader' },
      { text: 'Viernes', style: 'tableHeader' },
      { text: 'S√°bado', style: 'tableHeader' },
      { text: 'Domingo', style: 'tableHeader' },
      { text: 'Periodo', style: 'tableHeader' },
      { text: 'Comentario', style: 'tableHeader' }
    ]
  ];

  rows.forEach(tr => {
    const tds = tr.querySelectorAll('td');
    body.push([
      { text: tds[0]?.innerText || '', style: 'tableCell' },
      { text: tds[1]?.innerText || '', style: 'tableCell' },
      { text: tds[2]?.innerText || '', style: 'tableCell' },
      { text: tds[3]?.innerText || '', style: 'tableCell' },
      { text: tds[4]?.innerText || '', style: 'tableCell' },
      { text: tds[5]?.innerText || '', style: 'tableCell' },
      { text: tds[6]?.innerText || '', style: 'tableCell' },
      { text: tds[7]?.innerText || '', style: 'tableCell' },
      { text: tds[8]?.innerText || '', style: 'tableCell' },
      { text: tds[9]?.innerText || '', style: 'tableCell' },
      { text: tds[10]?.innerText || '', style: 'tableCell' },
      { text: tds[12]?.innerText || '', style: 'tableCell', alignment: 'left' },
      { text: tds[13]?.innerText || '', style: 'tableCell', alignment: 'left' }
    ]);
  });

  const docDefinition = {
    pageOrientation: 'landscape',
    content: [
      { text: 'TURNOS PROGRAMADOS', style: 'header' },
      { text: areaText, style: 'subheader' },
    
      {
        table: {
          headerRows: 1,
          widths: [
            55, 55, 55, 55, // Nombre, Documento, Cargo, √Årea
            35, 35, 35, 35, 35, 35, 35, // Lunes a Domingo
            45, // Tipo de Turno
            70, // Periodo
            90  // Comentario
          ],
          body: body
        },
        layout: 'lightHorizontalLines'
      },
      
      // Agregar espacio y l√≠nea de firma
      { text: '\n' }, // Espacio en blanco
      { 
        text: 'FIRMA ________________', 
        style: 'firma',
        alignment: 'right',
        margin: [0, 30, 40, 0] // Margen: [left, top, right, bottom]
      }
    ],
    
    styles: {
      header: { fontSize: 14, bold: true, alignment: 'center', margin: [0, 0, 0, 8] },
      subheader: { fontSize: 11, bold: true, margin: [0, 0, 0, 4] },
      tableHeader: {
        fillColor: '#1976d2',
        color: '#fff',
        bold: true,
        fontSize: 8,
        alignment: 'center'
      },
      tableCell: {
        fontSize: 7,
        margin: [1, 1, 1, 1],
        alignment: 'center'
      },
      firma: {
        fontSize: 10,
        bold: true
      }
    }
  };

  pdfMake.createPdf(docDefinition).download('turnos_programados.pdf');
}
// ...existing code...
// ...existing code...
// Mejorar cierre del modal de turnos programados
document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('turnosProgramadosModal');
  const closeBtn = modal.querySelector('.schedule-close');

  // Cerrar con clic fuera del modal
  window.addEventListener('mousedown', function (e) {
    if (modal.style.display === 'flex') {
      // Si el click es fuera del contenido
      const content = modal.querySelector('.schedule-content');
      if (content && !content.contains(e.target)) {
        cerrarModalTurnosProgramados();
      }
    }
  });

  // Cerrar con ESC
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape' && modal.style.display === 'flex') {
      cerrarModalTurnosProgramados();
    }
  });

  // Asegurar que la X siempre est√© visible y fija arriba a la derecha
  if (closeBtn) {
    closeBtn.style.position = 'fixed';
    closeBtn.style.top = '20px';
    closeBtn.style.right = '20px';
    closeBtn.style.zIndex = '9999';
    closeBtn.style.background = '#fff';
    closeBtn.style.borderRadius = '50%';
    closeBtn.style.width = '40px';
    closeBtn.style.height = '40px';
    closeBtn.style.fontSize = '2em';
    closeBtn.style.display = 'flex';
    closeBtn.style.alignItems = 'center';
    closeBtn.style.justifyContent = 'center';
    closeBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
    closeBtn.style.cursor = 'pointer';
    
  }
});


// ==============================================
// C√ìDIGO DEL CALENDARIO - VERSI√ìN SIMPLIFICADA
// ==============================================

// Variables globales para el calendario
// ==============================================
// C√ìDIGO DEL CALENDARIO MEJORADO - CON TURNOS POR D√çA
// ==============================================

// ==============================================
// C√ìDIGO DEL CALENDARIO MEJORADO - CON TURNOS POR D√çA
// ==============================================

// ==============================================
// C√ìDIGO COMPLETO DEL CALENDARIO - TODAS LAS FUNCIONES INCLUIDAS
// ==============================================

// Variables globales para el calendario
let calendarioActual = {
    fecha: new Date(),
    fechaSeleccionada: null,
    diasFestivos: {},
    turnosSemana: {
        lunes: 'DESCANSO',
        martes: 'DESCANSO', 
        miercoles: 'DESCANSO',
        jueves: 'DESCANSO',
        viernes: 'DESCANSO',
        sabado: 'DESCANSO',
        domingo: 'DESCANSO'
    }
};

// FUNCIONES B√ÅSICAS DEL CALENDARIO
function abrirModalCalendario() {
    console.log('Abriendo modal de calendario...');
    try {
        document.getElementById('weekCalendarModal').style.display = 'flex';
        // Cargar turnos actuales si existen
        cargarTurnosActuales();
        cargarFestivosYRenderizar();
    } catch (error) {
        console.error('Error al abrir modal de calendario:', error);
    }
}

function cerrarModalCalendario() {
    console.log('Cerrando modal de calendario...');
    try {
        document.getElementById('weekCalendarModal').style.display = 'none';
        calendarioActual.fechaSeleccionada = null;
    } catch (error) {
        console.error('Error al cerrar modal de calendario:', error);
    }
}

function cambiarMes(direccion) {
    console.log('Cambiando mes:', direccion);
    try {
        calendarioActual.fecha.setMonth(calendarioActual.fecha.getMonth() + direccion);
        renderizarCalendario();
    } catch (error) {
        console.error('Error al cambiar mes:', error);
    }
}

// Cargar d√≠as festivos y renderizar calendario
function cargarFestivosYRenderizar() {
    console.log('Cargando d√≠as festivos...');
    try {
        google.script.run
            .withSuccessHandler(function(festivos) {
                console.log('D√≠as festivos cargados:', festivos);
                calendarioActual.diasFestivos = festivos;
                renderizarCalendario();
            })
            .withFailureHandler(function(error) {
                console.error('Error al cargar d√≠as festivos:', error);
                calendarioActual.diasFestivos = {};
                renderizarCalendario();
            })
            .obtenerDiasFestivos();
    } catch (error) {
        console.error('Error en cargarFestivosYRenderizar:', error);
        calendarioActual.diasFestivos = {};
        renderizarCalendario();
    }
}

// Renderizar el calendario
function renderizarCalendario() {
    console.log('Renderizando calendario...');
    try {
        const contenedor = document.getElementById('calendarDaysContainer');
        const titulo = document.getElementById('calendarMonthYear');
        
        if (!contenedor || !titulo) {
            console.error('Elementos del calendario no encontrados');
            return;
        }

        const fecha = calendarioActual.fecha;
        const a√±o = fecha.getFullYear();
        const mes = fecha.getMonth();
        
        // Actualizar t√≠tulo
        const nombresMeses = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        titulo.textContent = `${nombresMeses[mes]} ${a√±o}`;
        
        // Calcular d√≠as a mostrar
        const primerDiaMes = new Date(a√±o, mes, 1);
        const ultimoDiaMes = new Date(a√±o, mes + 1, 0);
        const primerDiaSemana = primerDiaMes.getDay();
        const diasMesAnterior = primerDiaSemana === 0 ? 6 : primerDiaSemana - 1;
        
        // Limpiar contenedor
        contenedor.innerHTML = '';
        
        // Agregar d√≠as del mes anterior
        const mesAnterior = new Date(a√±o, mes, 0);
        for (let i = diasMesAnterior - 1; i >= 0; i--) {
            const dia = new Date(a√±o, mes - 1, mesAnterior.getDate() - i);
            agregarDiaCalendario(dia, true, contenedor);
        }
        
        // Agregar d√≠as del mes actual
        for (let dia = 1; dia <= ultimoDiaMes.getDate(); dia++) {
            const fechaDia = new Date(a√±o, mes, dia);
            agregarDiaCalendario(fechaDia, false, contenedor);
        }
        
        // Completar con d√≠as del pr√≥ximo mes
        const totalDiasMostrados = diasMesAnterior + ultimoDiaMes.getDate();
        const diasFaltantes = 42 - totalDiasMostrados; // 6 semanas
        
        for (let dia = 1; dia <= diasFaltantes; dia++) {
            const fechaDia = new Date(a√±o, mes + 1, dia);
            agregarDiaCalendario(fechaDia, true, contenedor);
        }
        
        console.log('Calendario renderizado correctamente');
        
    } catch (error) {
        console.error('Error al renderizar calendario:', error);
    }
}

// Agregar un d√≠a al calendario
function agregarDiaCalendario(fecha, esOtroMes, contenedor) {
    try {
        const diaElemento = document.createElement('div');
        diaElemento.className = 'calendar-day';
        
        if (esOtroMes) {
            diaElemento.classList.add('other-month');
        }
        
        // Verificar si es hoy
        const hoy = new Date();
        if (fecha.toDateString() === hoy.toDateString()) {
            diaElemento.classList.add('today');
        }
        
        // Verificar si es festivo
        const fechaStr = formatearFechaISO(fecha);
        const a√±oStr = fecha.getFullYear().toString();
        if (calendarioActual.diasFestivos[a√±oStr] && 
            calendarioActual.diasFestivos[a√±oStr].includes(fechaStr)) {
            diaElemento.classList.add('festivo');
        }
        
        // Verificar si est√° seleccionado
        if (calendarioActual.fechaSeleccionada && 
            fecha.toDateString() === calendarioActual.fechaSeleccionada.toDateString()) {
            diaElemento.classList.add('selected');
        }
        
        // Contenido del d√≠a
        const numeroDia = document.createElement('div');
        numeroDia.className = 'day-number';
        numeroDia.textContent = fecha.getDate();
        
        const numeroSemana = document.createElement('div');
        numeroSemana.className = 'week-number';
        numeroSemana.textContent = `S${obtenerNumeroSemana(fecha)}`;
        
        diaElemento.appendChild(numeroDia);
        diaElemento.appendChild(numeroSemana);
        
        // Solo hacer clickable los d√≠as del mes actual
        if (!esOtroMes) {
            diaElemento.onclick = function() {
                seleccionarDia(fecha);
            };
        }
        
        contenedor.appendChild(diaElemento);
        
    } catch (error) {
        console.error('Error al agregar d√≠a al calendario:', error);
    }
}

// FUNCIONES UTILITARIAS
function formatearFechaISO(fecha) {
    try {
        return fecha.toISOString().split('T')[0];
    } catch (error) {
        console.error('Error al formatear fecha:', error);
        return '';
    }
}

function obtenerNumeroSemana(fecha) {
    try {
        const primerDiaA√±o = new Date(fecha.getFullYear(), 0, 1);
        const diasTranscurridos = Math.floor((fecha - primerDiaA√±o) / (24 * 60 * 60 * 1000));
        return Math.ceil((diasTranscurridos + primerDiaA√±o.getDay() + 1) / 7);
    } catch (error) {
        console.error('Error al obtener n√∫mero de semana:', error);
        return 0;
    }
}

function obtenerLunesSemana(fecha) {
    try {
        const dia = fecha.getDay();
        const diferencia = fecha.getDate() - dia + (dia === 0 ? -6 : 1);
        return new Date(fecha.setDate(diferencia));
    } catch (error) {
        console.error('Error al obtener lunes de semana:', error);
        return new Date();
    }
}

// FUNCIONES DE SELECCI√ìN Y TURNOS
function seleccionarDia(fecha) {
    console.log('D√≠a seleccionado:', fecha);
    try {
        calendarioActual.fechaSeleccionada = fecha;
        actualizarInfoSemanaSeleccionada();
        
        // Mostrar informaci√≥n √∫til sobre la semana seleccionada
        mostrarInformacionSemana(fecha);
        
        renderizarCalendario();
    } catch (error) {
        console.error('Error al seleccionar d√≠a:', error);
    }
}

function actualizarInfoSemanaSeleccionada() {
    try {
        const displayElement = document.getElementById('selectedWeekDisplay');
        const botonConfirmar = document.getElementById('confirmWeekSelection');
        
        if (!calendarioActual.fechaSeleccionada) {
            displayElement.textContent = 'Por favor, selecciona un d√≠a en el calendario para ver la semana completa';
            botonConfirmar.disabled = true;
            return;
        }
        
        const lunes = obtenerLunesSemana(new Date(calendarioActual.fechaSeleccionada));
        const domingo = new Date(lunes);
        domingo.setDate(lunes.getDate() + 6);
        
        const opciones = { day: 'numeric', month: 'long', year: 'numeric' };
        const textoRango = `Del ${lunes.toLocaleDateString('es-ES', opciones)} al ${domingo.toLocaleDateString('es-ES', opciones)}`;
        
        displayElement.textContent = textoRango;
        botonConfirmar.disabled = false;
        
    } catch (error) {
        console.error('Error al actualizar info de semana:', error);
    }
}

function mostrarInformacionSemana(fecha) {
    try {
        const lunes = obtenerLunesSemana(new Date(fecha));
        const hoy = new Date();
        const diferenciaDias = Math.floor((lunes - hoy) / (1000 * 60 * 60 * 24));
        
        let mensajeInfo = '';
        
        if (diferenciaDias === 0) {
            mensajeInfo = 'üóìÔ∏è Esta semana (semana actual)';
        } else if (diferenciaDias === 7) {
            mensajeInfo = '‚è≠Ô∏è Pr√≥xima semana';
        } else if (diferenciaDias === -7) {
            mensajeInfo = '‚èÆÔ∏è Semana pasada';
        } else if (diferenciaDias > 0) {
            mensajeInfo = `üìÖ En ${diferenciaDias} d√≠as`;
        } else {
            mensajeInfo = `‚è∞ Hace ${Math.abs(diferenciaDias)} d√≠as`;
        }
        
        // Contar d√≠as festivos en la semana
        const diasFestivosEnSemana = contarDiasFestivosEnSemana(lunes);
        if (diasFestivosEnSemana > 0) {
            mensajeInfo += ` | üéâ ${diasFestivosEnSemana} d√≠a(s) festivo(s)`;
        }
        
        // Actualizar el display con informaci√≥n adicional
        const display = document.getElementById('selectedWeekDisplay');
        const textoOriginal = display.textContent;
        display.innerHTML = `${textoOriginal}<br><small style="color: #666;">${mensajeInfo}</small>`;
        
    } catch (error) {
        console.error('Error al mostrar informaci√≥n de semana:', error);
    }
}

function contarDiasFestivosEnSemana(lunes) {
    try {
        let count = 0;
        const a√±o = lunes.getFullYear().toString();
        const festivos = calendarioActual.diasFestivos[a√±o] || [];
        
        for (let i = 0; i < 7; i++) {
            const dia = new Date(lunes);
            dia.setDate(lunes.getDate() + i);
            const fechaStr = formatearFechaISO(dia);
            
            if (festivos.includes(fechaStr)) {
                count++;
            }
        }
        
        return count;
    } catch (error) {
        console.error('Error al contar d√≠as festivos:', error);
        return 0;
    }
}

// FUNCIONES DE GESTI√ìN DE TURNOS
function cargarTurnosActuales() {
    try {
        // Obtener turnos actuales del modal semanal
        const turnos = {};
        const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        
        dias.forEach(dia => {
            const select = document.querySelector(`#weeklyScheduleModal select[data-day="${dia}"]`);
            if (select) {
                turnos[dia] = select.value || 'DESCANSO';
            } else {
                turnos[dia] = 'DESCANSO';
            }
        });
        
        calendarioActual.turnosSemana = turnos;
        actualizarVistaTurnosDias();
        
    } catch (error) {
        console.error('Error al cargar turnos actuales:', error);
    }
}

function actualizarVistaTurnosDias() {
    try {
        const grid = document.getElementById('daysShiftsGrid');
        if (!grid) return;
        
        const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        
        dias.forEach(dia => {
            const elemento = grid.querySelector(`[data-day="${dia}"]`);
            if (elemento) {
                const turnoElement = elemento.querySelector('.day-shift-turno');
                const turno = calendarioActual.turnosSemana[dia] || 'DESCANSO';
                
                // Formatear el texto del turno para mejor visualizaci√≥n
                let textoTurno = turno;
                if (turno.includes('T1')) textoTurno = 'üü¢ ' + turno;
                else if (turno.includes('T2')) textoTurno = 'üîµ ' + turno;
                else if (turno.includes('T3')) textoTurno = 'üü° ' + turno;
                else if (turno === 'DESCANSO') textoTurno = 'üò¥ DESCANSO';
                else if (turno === 'VACACIONES') textoTurno = 'üèñÔ∏è VACACIONES';
                
                turnoElement.textContent = textoTurno;
                
                // Resaltar si no es descanso
                if (turno !== 'DESCANSO') {
                    elemento.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                    elemento.style.borderColor = '#28a745';
                } else {
                    elemento.style.background = '#ecf0f1';
                    elemento.style.borderColor = 'transparent';
                }
            }
        });
        
    } catch (error) {
        console.error('Error al actualizar vista de turnos:', error);
    }
}

function hacerDiasClickeables() {
    try {
        const grid = document.getElementById('daysShiftsGrid');
        if (!grid) return;
        
        const items = grid.querySelectorAll('.day-shift-item');
        items.forEach(item => {
            item.addEventListener('click', function() {
                const dia = this.getAttribute('data-day');
                mostrarOpcionesTurno(dia);
            });
        });
        
    } catch (error) {
        console.error('Error al hacer d√≠as clickeables:', error);
    }
}

function mostrarOpcionesTurno(dia) {
    const turnoActual = calendarioActual.turnosSemana[dia] || 'DESCANSO';
    
    // Crear un selector simple
    const nuevoTurno = prompt(
        `Selecciona turno para ${dia.toUpperCase()}:\n\n` +
        `Turno actual: ${turnoActual}\n\n` +
        `Opciones disponibles:\n` +
        `- T1, T2, T3\n` +
        `- T1 EXTRA, T2 EXTRA, T3 EXTRA\n` +
        `- DESCANSO\n` +
        `- VACACIONES\n` +
        `- INCAPACIDAD\n` +
        `- PERMISO\n\n` +
        `Escribe el nuevo turno:`,
        turnoActual
    );
    
    if (nuevoTurno !== null) {
        calendarioActual.turnosSemana[dia] = nuevoTurno.toUpperCase().trim();
        actualizarVistaTurnosDias();
        
        // Mostrar confirmaci√≥n
        const diaNombre = dia.toUpperCase();
        alert(`‚úÖ Turno para ${diaNombre} actualizado a: ${calendarioActual.turnosSemana[dia]}`);
    }
}

// FUNCI√ìN DE CONFIRMACI√ìN FINAL
function confirmarSeleccionSemana() {
    console.log('Confirmando selecci√≥n de semana...');
    try {
        if (!calendarioActual.fechaSeleccionada) {
            alert('Por favor, selecciona una semana primero');
            return;
        }
        
        const lunes = obtenerLunesSemana(new Date(calendarioActual.fechaSeleccionada));
        const a√±o = lunes.getFullYear();
        const numeroSemana = obtenerNumeroSemana(lunes);
        
        // Formatear como YYYY-Www
        const semanaFormato = `${a√±o}-W${numeroSemana.toString().padStart(2, '0')}`;
        
        console.log('Semana seleccionada:', semanaFormato);
        
        // 1. Actualizar el campo de semana en el modal semanal
        const campoSemana = document.getElementById('weekStart');
        if (campoSemana) {
            campoSemana.value = semanaFormato;
            console.log('Campo de semana actualizado:', campoSemana.value);
        }
        
        // 2. Aplicar los turnos configurados a los selects del modal semanal
        aplicarTurnosAModalSemanal();
        
        cerrarModalCalendario();
        
        // Mostrar resumen de lo aplicado
        mostrarResumenAplicacion(numeroSemana, a√±o);
        
    } catch (error) {
        console.error('Error al confirmar selecci√≥n:', error);
        alert('Error al seleccionar la semana. Por favor, intenta nuevamente.');
    }
}

function aplicarTurnosAModalSemanal() {
    try {
        const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        
        dias.forEach(dia => {
            const select = document.querySelector(`#weeklyScheduleModal select[data-day="${dia}"]`);
            if (select) {
                const turno = calendarioActual.turnosSemana[dia] || 'DESCANSO';
                select.value = turno;
                console.log(`Turno aplicado para ${dia}: ${turno}`);
            }
        });
        
    } catch (error) {
        console.error('Error al aplicar turnos al modal semanal:', error);
    }
}

function mostrarResumenAplicacion(numeroSemana, a√±o) {
    const diasConTurno = Object.entries(calendarioActual.turnosSemana)
        .filter(([dia, turno]) => turno !== 'DESCANSO')
        .map(([dia]) => dia);
    
    let mensaje = `‚úÖ Semana ${numeroSemana} del ${a√±o} configurada correctamente.`;
    
    if (diasConTurno.length > 0) {
        mensaje += `\n\nTurnos aplicados en: ${diasConTurno.map(d => d.toUpperCase()).join(', ')}`;
    } else {
        mensaje += `\n\n‚ÑπÔ∏è Todos los d√≠as en DESCANSO. Modifica los turnos si es necesario.`;
    }
    
    alert(mensaje);
}

// INICIALIZACI√ìN
function inicializarCalendario() {
    console.log('Inicializando calendario completo...');
    
    // Inicializar d√≠as clickeables cuando el modal se abra
    const abrirModalCalendarioOriginal = abrirModalCalendario;
    abrirModalCalendario = function() {
        abrirModalCalendarioOriginal();
        setTimeout(hacerDiasClickeables, 500);
    };
    
    // Modificar la funci√≥n abrirModalSemanal para usar solo el nuevo calendario
    const abrirModalSemanalOriginal = abrirModalSemanal;
    abrirModalSemanal = function() {
        abrirModalSemanalOriginal();
        
        // Agregar bot√≥n de calendario MEJORADO
        setTimeout(function() {
            const selectorSemana = document.querySelector('.week-selector');
            if (selectorSemana && !selectorSemana.querySelector('.calendar-picker-btn')) {
                const botonCalendario = document.createElement('button');
                botonCalendario.type = 'button';
                botonCalendario.className = 'calendar-picker-btn';
                botonCalendario.innerHTML = 'üìÖ Abrir Calendario de Turnos';
                botonCalendario.onclick = abrirModalCalendario;
                
                // Agregar descripci√≥n
                const descripcion = document.createElement('small');
                descripcion.style.display = 'block';
                descripcion.style.marginTop = '5px';
                descripcion.style.color = '#666';
                descripcion.textContent = 'Selecciona semanas y configura turnos visualmente';
                
                selectorSemana.appendChild(botonCalendario);
                selectorSemana.appendChild(descripcion);
            }
        }, 100);
    };
    
    console.log('Calendario inicializado correctamente');
}

// Ejecutar cuando cargue la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    console.log('Cargando calendario mejorado...');
    inicializarCalendario();
});
 </script>
</body>
</html>
